<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content=""/>
  <meta name="author" content="Reber"/>
  
    
      <title>PHP 之封装 MySQL 类 | Reber&#39;s Blog</title>
    
  
  <link rel="stylesheet" href="/css/reset.css"/>
  
  <link rel="stylesheet" href="/css/smigle.css"/>
  
    <link rel="stylesheet" href="/css/monokai-sublime.min.css"/>
  
    <link rel="stylesheet" href="/css/style.css"/>
  
  
    <script src="/js/jquery-3.6.0.min.js"/></script>
  
    <script src="/js/highlight.min.js"/></script>
  
    <script src="/js/style.js"/></script>
  
  <link rel="icon" type="image/img" sizes="16x16" href="/img/logo.png">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
</head>

  <body>
    <header>
  <div id="brand">
    <a class="icon-link" href="https://wyb0.com/">
      <img
        class="icon"
        src="/img/logo.png"
      />
    </a>
    <div class="text">
      <a href="https://wyb0.com/"><h1>Reber&#39;s Blog</h1></a>
      <h3>只会一点点编程、只会一点点渗透</h3>
    </div>
  </div>
  <nav>
    
      
        
        <a href="/"><b>Home</b></a>
      
         | 
        <a href="/posts/"><b>Posts</b></a>
      
         | 
        <a href="/categories/"><b>Categories</b></a>
      
         | 
        <a href="/tags/"><b>Tags</b></a>
      
         | 
        <a href="/about/"><b>About</b></a>
      
         | 
        <a href="/friends/"><b>Friends</b></a>
      
    
  </nav>
  <hr />
</header>

    <div id="content">
      
  <main>
    <article>
      <h1>PHP 之封装 MySQL 类</h1>
      
<div class="post-meta">
    <time>2016-06-03</time>
    
    [<a href="/categories/PHP">PHP</a>,<a href="/categories/Database">Database</a>](<a href="/tags/php">php</a>,<a href="/tags/mysql">mysql</a>)
</div>

      <div><h3 id="0x00-configincphp内容如下">0x00 config.inc.php内容如下</h3>
<pre tabindex="0"><code>&lt;?php
return array(
    &#39;DB_HOST&#39; =&gt; &#39;192.168.188.134&#39;,
    &#39;DB_NAME&#39; =&gt; &#39;scoreboard&#39;, 
    &#39;DB_USER&#39; =&gt; &#39;score&#39;,
    &#39;DB_PASS&#39; =&gt; &#39;123456&#39;,
    &#39;DB_CHARSET&#39; =&gt; &#39;utf8&#39;,
    &#39;IS_LOG&#39; =&gt; 1,//开启日志
    &#39;LOGFILEPATH&#39; =&gt; &#39;../log.txt&#39;//日志路径
);
/*
    $database = require(&#39;./config.php&#39;);
    echo $database[&#39;DB_TYPE&#39;];   //输出&#39;DB_TYPE&#39;
*/

?&gt;
</code></pre><h3 id="0x01-表设计如下">0x01 表设计如下</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">database</span> scoreboard;
</span></span><span style="display:flex;"><span>use scoreboard;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">drop</span> <span style="color:#66d9ef">table</span> <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">exists</span> users;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> users(
</span></span><span style="display:flex;"><span>    id int <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span> auto_increment <span style="color:#66d9ef">primary</span> <span style="color:#66d9ef">key</span>,
</span></span><span style="display:flex;"><span>    gid int <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span> <span style="color:#66d9ef">default</span> <span style="color:#e6db74">&#39;xiaoming&#39;</span> <span style="color:#66d9ef">comment</span> <span style="color:#e6db74">&#39;组id&#39;</span>,
</span></span><span style="display:flex;"><span>    username varchar(<span style="color:#ae81ff">20</span>) <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span> <span style="color:#66d9ef">default</span> <span style="color:#e6db74">&#39;xiaoming&#39;</span> <span style="color:#66d9ef">comment</span> <span style="color:#e6db74">&#39;用户名&#39;</span>,
</span></span><span style="display:flex;"><span>    password varchar(<span style="color:#ae81ff">32</span>) <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span> <span style="color:#66d9ef">default</span> <span style="color:#e6db74">&#39;123456&#39;</span> <span style="color:#66d9ef">comment</span> <span style="color:#e6db74">&#39;密码&#39;</span>,
</span></span><span style="display:flex;"><span>    sex varchar(<span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span> <span style="color:#66d9ef">default</span> <span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#66d9ef">comment</span> <span style="color:#e6db74">&#39;性别&#39;</span>,
</span></span><span style="display:flex;"><span>    totalscore int <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span> <span style="color:#66d9ef">default</span> <span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#66d9ef">comment</span> <span style="color:#e6db74">&#39;个人总积分&#39;</span>
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">drop</span> <span style="color:#66d9ef">table</span> <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">exists</span> <span style="color:#66d9ef">share</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> <span style="color:#66d9ef">share</span>(
</span></span><span style="display:flex;"><span>    id int <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span> auto_increment <span style="color:#66d9ef">primary</span> <span style="color:#66d9ef">key</span>,
</span></span><span style="display:flex;"><span>    uid int <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span>,
</span></span><span style="display:flex;"><span>    content varchar(<span style="color:#ae81ff">1024</span>) <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span> <span style="color:#66d9ef">default</span> <span style="color:#e6db74">&#39;content&#39;</span> <span style="color:#66d9ef">comment</span> <span style="color:#e6db74">&#39;分享内容&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">comment</span> varchar(<span style="color:#ae81ff">1024</span>) <span style="color:#66d9ef">comment</span> <span style="color:#e6db74">&#39;点评&#39;</span>,
</span></span><span style="display:flex;"><span>    date varchar(<span style="color:#ae81ff">15</span>) <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span> <span style="color:#66d9ef">default</span> <span style="color:#e6db74">&#39;20150101&#39;</span> <span style="color:#66d9ef">comment</span> <span style="color:#e6db74">&#39;分享日期&#39;</span>
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">drop</span> <span style="color:#66d9ef">table</span> <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">exists</span> score;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> score(
</span></span><span style="display:flex;"><span>    id int <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span> auto_increment <span style="color:#66d9ef">primary</span> <span style="color:#66d9ef">key</span>,
</span></span><span style="display:flex;"><span>    uid int <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span> <span style="color:#66d9ef">default</span> <span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#66d9ef">comment</span> <span style="color:#e6db74">&#39;用户id&#39;</span>,
</span></span><span style="display:flex;"><span>    score int <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span> <span style="color:#66d9ef">default</span> <span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#66d9ef">comment</span> <span style="color:#e6db74">&#39;用户单次积分&#39;</span>,
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">grant</span> <span style="color:#66d9ef">all</span> <span style="color:#66d9ef">privileges</span> <span style="color:#66d9ef">on</span> scoreboard.<span style="color:#f92672">*</span> <span style="color:#66d9ef">to</span> <span style="color:#e6db74">&#39;score&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span> identified <span style="color:#66d9ef">by</span> <span style="color:#e6db74">&#39;123456&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 或者只给特定权限
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">-- grant select,update,delete on scoreboard.* to &#39;score&#39;@&#39;%&#39; identified by &#39;123456&#39;;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>flush <span style="color:#66d9ef">privileges</span>;
</span></span></code></pre></div><h3 id="0x02-封装类如下">0x02 封装类如下</h3>
<pre tabindex="0"><code>&lt;?php

class mysql {
    private $logfilepath;
    private $is_log;
    private $hlog;
    private $conn;

    //构造函数
    public function __construct() {
        $config = include_once(dirname(__FILE__).&#34;/../config/config.inc.php&#34;);
        $this-&gt;is_log = $config[&#39;IS_LOG&#39;];
        $this-&gt;logfilepath = $config[&#39;LOGFILEPATH&#39;];

        if ($this-&gt;is_log){
            $handle = fopen($this-&gt;logfilepath,&#34;a+&#34;);
            $this-&gt;hlog = $handle;
        }

        $this-&gt;conn = $this-&gt;connect($config[&#39;DB_HOST&#39;],$config[&#39;DB_USER&#39;],$config[&#39;DB_PASS&#39;],$config[&#39;DB_NAME&#39;],$config[&#39;DB_CHARSET&#39;]);
    }

    //连接数据库
    public function connect($dbhost, $dbuser, $dbpass, $dbname, $dbcharset) {
        $this-&gt;conn = @mysql_connect($dbhost,$dbuser,$dbpass);
        if (!$this-&gt;conn) {
            $msg = &#34;连接数据库失败：&#34;.mysql_error();
            $this-&gt;write_log($msg);
            die($msg);
        } else {
            if (!@mysql_select_db($dbname)) {
                $msg = &#34;连接数据库成功，但选择数据库失败：&#34;.mysql_error();
                $this-&gt;write_log($msg);
                die($msg);
            } else {
                $msg = &#34;连接数据库成功，且选择数据库成功&#34;;
                $this-&gt;write_log($msg);
            }
        }

        @mysql_query(&#34;set names &#34;.$dbcharset);

    }

    //执行语句
    public function query($sql) {
        
        $result = @mysql_query($sql);

        if (!$result) {
            $this-&gt;write_log(&#39;mysql_query error:&#39;.mysql_error());
        } else {
            $this-&gt;write_log(&#39;执行语句：&#39;.$sql.&#39; 且执行成功&#39;);
        }
        return $result;
    }

    //查询一条数据
    public function select_one($tab,$column = &#34;*&#34;,$condition = &#39;&#39;,$debug=False) {   //查询函数
        $condition = $condition ? &#39; where &#39; . $condition : NULL;
        $sql = &#34;select $column from $tab $condition &#34;;
        if ($debug) {
            echo &#39;将执行语句：&#39;.$sql.&#39;&lt;br /&gt;&#39;;
        } else {
            $result = $this-&gt;query($sql);
            $row = @mysql_fetch_assoc($result);
            return $row;
        }
    }

    //查询多条数据
    public function select_more($tab,$column = &#34;*&#34;,$condition = &#39;&#39;,$debug=False) {   //查询函数
        $condition = $condition ? &#39; where &#39; . $condition : NULL;
        $sql = &#34;select $column from $tab $condition&#34;;
        if ($debug) {
            echo &#39;将执行语句：&#39;.$sql;
        } else {
            $result = $this-&gt;query($sql);
            $i = 0;
            $rows = array();
            while ($row = @mysql_fetch_assoc($result)) {
                $rows[$i] = $row;
                // print_r($rows[$i]);
                $i++; 
            }
            return $rows;
        }
    }

    //返回结果集
    public function echo_result($tab,$column = &#34;*&#34;,$condition = &#39;&#39;,$debug=False) {   //查询函数
        $condition = $condition ? &#39; where &#39; . $condition : NULL;
        $sql = &#34;select $column from $tab $condition &#34;;
        if ($debug) {
            echo &#39;将执行语句：&#39;.$sql.&#39;&lt;br /&gt;&#39;;
        } else {
            return $this-&gt;query($sql);
        }
    }

    //插入数据
    public function insert($tab,$arr,$debug=False) {
        $value = &#39;&#39;;
        $column = &#39;&#39;;
        foreach ($arr as $k =&gt; $v) {
            $column .= &#34;,{$k}&#34;;
            $value .= &#34;,&#39;{$v}&#39;&#34;;
        }
        $column = substr($column, 1);
        $value = substr($value, 1);

        $sql = &#34;insert into $tab($column) values($value)&#34;;
        if ($debug) {
            echo &#39;将执行语句：&#39;.$sql;
        } else {
            $this-&gt;query($sql);
            $num = $this-&gt;affected_num();
            $this-&gt;write_log(&#34;受影响行数：&#34;.$num);
            return $num;    //返回受影响行数
        }
    }

    //获取最后插入的id
    public function insert_id() {
        $id = mysql_insert_id($this-&gt;link_id);
        $this-&gt;write_log(&#39;最后插入的id为：&#39;.$id);
        return $id;
    }

    //更新数据
    public function update($tab,$arr,$condition = &#39;&#39;,$debug=False) {
        if (!$condition) {
            die(&#34;error&#34;.mysql_error());
        } else {
            $condition = &#39;where &#39; . $condition;
        }
        
        $value = &#39;&#39;;
        foreach ($arr as $k =&gt; $v) {
            $value .= &#34;{$k}=&#39;{$v}&#39;,&#34;;
        }
        $value = substr($value,0,-1);

        $sql = &#34;update $tab set $value $condition&#34;;
        if ($debug) {
            echo &#39;将执行语句：&#39;.$sql;
        } else {
            $this-&gt;query($sql);
            $num = $this-&gt;affected_num();
            $this-&gt;write_log(&#34;受影响行数：&#34;.$num);

            return $num;            
        }
    }

    //删除数据
    public function delete($tab,$condition=&#39;&#39;,$debug=False) {
        $condition = $condition ? &#39; where &#39; . $condition : NULL;
        $sql = &#34;delete from $tab $condition&#34;;
        if ($debug) {
            echo &#39;将执行语句：&#39;.$sql;
        } else {
            $this-&gt;query($sql);
            $num = $this-&gt;affected_num();
            $this-&gt;write_log(&#34;受影响行数：&#34;.$num);
            return $num;    //返回受影响行数
        }
    }

    //返回受影响行数
    public function affected_num() {
        $num = @mysql_affected_rows();
        return $num;
    }

    //写入日志
    public function write_log($msg=&#39;&#39;) {
        if ($this-&gt;is_log){
            $text = date(&#34;Y-m-d H:i:s&#34;).&#34; &#34;.$msg.&#34;\r\n&#34;;
            fwrite($this-&gt;hlog,$text);
        }
    }

    //关闭数据库连接
    public function close() {  
        mysql_close($this-&gt;conn);
    }

    //析构函数
    public function __destruct() {
        if($this-&gt;is_log){
            fclose($this-&gt;hlog);
        }
    }
}

    //$db = new mysql();
    
    // //select_one($tab,$column = &#34;*&#34;,$condition = &#39;&#39;)
    // $rows = $db-&gt;select_more(&#39;share&#39;,&#39;*&#39;);
    // print_r($rows[0]);
    // print_r($rows[1]);

    // //insert($tab,$arr)
    // $arr = array();
    // $arr[&#39;uid&#39;] = &#39;3&#39;;
    // $arr[&#39;content&#39;] = &#39;xss&#39;;
    // $arr[&#39;comment&#39;] = &#39;very good&#39;;
    // $arr[&#39;date&#39;] = &#39;1464082630&#39;;
    // $db-&gt;insert(&#39;share&#39;,$arr);

    // //update($tab,$arr,$condition = &#39;&#39;)
    // $arr = array();
    // $arr[&#39;content&#39;] = &#39;xssxssxssxssxss&#39;;
    // $arr[&#39;comment&#39;] = &#39;goodgoodgoodgood&#39;;
    // $condition = &#39;id &gt; 5&#39;;
    // $db-&gt;update(&#39;share&#39;,$arr,$condition);

    //$db-&gt;delete(&#34;share&#34;,&#34;id between 10 and 15&#34;);

    //$db-&gt;close();
?&gt;
</code></pre></div>
    </article>
  </main>

    </div>
    <footer>
  <hr />
  
    <p id="social">
      Find me around the web:
      
        
        <a href="https://github.com/reber0?_blank">GitHub</a>
      
         • 
        <a href="https://weibo.com/u/5819760166?_blank">Weibo</a>
      
    </p>
  
  <p class="copyright">
    Copyright © 2015-2024
    <a href="https://wyb0.com/"><strong>Reber</strong></a>.

    Built with
    <a href="http://www.gohugo.io/">Hugo</a>,
    based on the theme
    <a href="https://gitlab.com/ian-s-mcb/smigle-hugo-theme">smigle</a>.
  </p>
</footer>

  </body>
</html>
