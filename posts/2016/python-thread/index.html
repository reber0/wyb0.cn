<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content=""/>
  <meta name="author" content="Reber"/>
  
    
      <title>Python 的线程 | Reber&#39;s Blog</title>
    
  
  <link rel="stylesheet" href="/css/reset.css"/>
  
  <link rel="stylesheet" href="/css/smigle.css"/>
  
    <link rel="stylesheet" href="/css/monokai-sublime.min.css"/>
  
    <link rel="stylesheet" href="/css/style.css"/>
  
  
    <script src="/js/jquery-3.6.0.min.js"/></script>
  
    <script src="/js/highlight.min.js"/></script>
  
    <script src="/js/style.js"/></script>
  
  <link rel="icon" type="image/img" sizes="16x16" href="/img/logo.png">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
</head>

  <body>
    <header>
  <div id="brand">
    <a class="icon-link" href="https://wyb0.com/">
      <img
        class="icon"
        src="/img/logo.png"
      />
    </a>
    <div class="text">
      <a href="https://wyb0.com/"><h1>Reber&#39;s Blog</h1></a>
      <h3>只会一点点编程、只会一点点渗透</h3>
    </div>
  </div>
  <nav>
    
      
        
        <a href="/"><b>Home</b></a>
      
         | 
        <a href="/posts/"><b>Posts</b></a>
      
         | 
        <a href="/categories/"><b>Categories</b></a>
      
         | 
        <a href="/tags/"><b>Tags</b></a>
      
         | 
        <a href="/about/"><b>About</b></a>
      
         | 
        <a href="/friends/"><b>Friends</b></a>
      
    
  </nav>
  <hr />
</header>

    <div id="content">
      
  <main>
    <article>
      <h1>Python 的线程</h1>
      
<div class="post-meta">
    <time>2016-02-03</time>
    
    [<a href="/categories/Python">Python</a>](<a href="/tags/python">python</a>,<a href="/tags/thread">thread</a>)
</div>

      <div><p>Python的参数传递其实传递的是对象，当传递可变对象(列表、队列)时相当于引用传递，可以修改对象的原始值，当传递不可变对象(字符串、整型)时就相当于传值，不能直接修改原始对象。</p>
<h3 id="0x00-单线程">0x00 单线程</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -*- coding: utf-8 -*-</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> time <span style="color:#f92672">import</span> time,ctime,sleep
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">music</span>(arg):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">2</span>):
</span></span><span style="display:flex;"><span>        print <span style="color:#e6db74">&#34;I&#39;m listening to </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">. </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (arg,ctime())
</span></span><span style="display:flex;"><span>        sleep(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">movie</span>(arg):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">2</span>):
</span></span><span style="display:flex;"><span>        print <span style="color:#e6db74">&#34;I&#39;m watching </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">. </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (arg,ctime())
</span></span><span style="display:flex;"><span>        sleep(<span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    start <span style="color:#f92672">=</span> int(time())
</span></span><span style="display:flex;"><span>    music(<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;我&#39;</span>)
</span></span><span style="display:flex;"><span>    movie(<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;可是&#39;</span>)
</span></span><span style="display:flex;"><span>    print <span style="color:#e6db74">&#34;All over time:</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> ctime()
</span></span><span style="display:flex;"><span>    print <span style="color:#e6db74">&#34;Used time:</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> int(time()<span style="color:#f92672">-</span>start)
</span></span></code></pre></div><p><img src="/img/post/thread_single.png" alt="单线程"></p>
<h3 id="0x01-多线程">0x01 多线程</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -*- coding: utf-8 -*-</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> re
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> threading
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> time <span style="color:#f92672">import</span> time,ctime,sleep
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>INDEX <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">http_get</span>(sites):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">global</span> INDEX
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> INDEX <span style="color:#f92672">&lt;</span> len(sites):
</span></span><span style="display:flex;"><span>        url <span style="color:#f92672">=</span> sites[INDEX]
</span></span><span style="display:flex;"><span>        INDEX <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        resp <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>        resp<span style="color:#f92672">.</span>encoding <span style="color:#f92672">=</span> resp<span style="color:#f92672">.</span>apparent_encoding
</span></span><span style="display:flex;"><span>        title <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>search(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;&lt;title&gt;(.*?)&lt;/title&gt;&#39;</span>, resp<span style="color:#f92672">.</span>text)<span style="color:#f92672">.</span>group(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        print <span style="color:#e6db74">&#34;URL:</span><span style="color:#e6db74">%-30s</span><span style="color:#e6db74">Title:</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (url, title)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sites <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;http://www.baidu.com&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;http://www.qq.com&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;http://www.github.com&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;http://www.jingyingba.com&#34;</span>,
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    start <span style="color:#f92672">=</span> int(time())
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    threads <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">3</span>):
</span></span><span style="display:flex;"><span>        t <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Thread(target<span style="color:#f92672">=</span>http_get, args<span style="color:#f92672">=</span>(sites,))
</span></span><span style="display:flex;"><span>        threads<span style="color:#f92672">.</span>append(t)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> t <span style="color:#f92672">in</span> threads:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#t.setDaemon(True) #设为守护线程,主线程结束后不管子线程是否完成,立即结束</span>
</span></span><span style="display:flex;"><span>        t<span style="color:#f92672">.</span>start()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> t <span style="color:#f92672">in</span> threads:
</span></span><span style="display:flex;"><span>        t<span style="color:#f92672">.</span>join() <span style="color:#75715e">#主线程阻塞，等待子线程完成</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    print <span style="color:#e6db74">&#34;Used time:</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> int(time() <span style="color:#f92672">-</span> start)
</span></span></code></pre></div><p><img src="/img/post/thread_multithreading.png" alt="多线程"></p>
<h3 id="0x02-线程同步">0x02 线程同步</h3>
<p>使用多线程时若线程共用一个资源则可能导致线程竞争问题，可以通过互斥锁和队列来解决</p>
<ul>
<li>线程竞争</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -*- coding: utf-8 -*-</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> re
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> threading
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> time <span style="color:#f92672">import</span> time,ctime,sleep
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>num <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">global</span> num
</span></span><span style="display:flex;"><span>    sleep(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    num <span style="color:#f92672">=</span> num<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Number: &#39;</span> <span style="color:#f92672">+</span> str(num)
</span></span><span style="display:flex;"><span>    print msg
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    start <span style="color:#f92672">=</span> int(time())
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    threads <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">20</span>):
</span></span><span style="display:flex;"><span>        t <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Thread(target<span style="color:#f92672">=</span>test)
</span></span><span style="display:flex;"><span>        threads<span style="color:#f92672">.</span>append(t)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> t <span style="color:#f92672">in</span> threads:
</span></span><span style="display:flex;"><span>        t<span style="color:#f92672">.</span>setDaemon(<span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>        t<span style="color:#f92672">.</span>start()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> t <span style="color:#f92672">in</span> threads:
</span></span><span style="display:flex;"><span>        t<span style="color:#f92672">.</span>join()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    print <span style="color:#e6db74">&#34;Used time:</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> int(time() <span style="color:#f92672">-</span> start)
</span></span></code></pre></div><p><img src="/img/post/thread_compete1.png" alt="线程竞争1"></p>
<p><img src="/img/post/thread_compete2.png" alt="线程竞争2"></p>
<ul>
<li>互斥锁</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -*- coding: utf-8 -*-</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">使用步骤：
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">1. 创建互斥锁 mutex = threading.Lock()
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">2. 锁定 mutex.acquire([timeout])
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">3. 释放 mutex.release()
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> re
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> threading
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> time <span style="color:#f92672">import</span> time,ctime,sleep
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>num <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>mutex <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Lock()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">global</span> num
</span></span><span style="display:flex;"><span>    sleep(<span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    mutex<span style="color:#f92672">.</span>acquire() <span style="color:#75715e">#这里存在线程竞争，设置互斥锁</span>
</span></span><span style="display:flex;"><span>    num <span style="color:#f92672">=</span> num<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    mutex<span style="color:#f92672">.</span>release()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;set num to &#39;</span><span style="color:#f92672">+</span>str(num)
</span></span><span style="display:flex;"><span>    mutex<span style="color:#f92672">.</span>acquire() <span style="color:#75715e">#输出有可能错乱，还是线程竞争问题</span>
</span></span><span style="display:flex;"><span>    print msg
</span></span><span style="display:flex;"><span>    mutex<span style="color:#f92672">.</span>release()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    start <span style="color:#f92672">=</span> int(time())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    threads <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">20</span>):
</span></span><span style="display:flex;"><span>        t <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Thread(target<span style="color:#f92672">=</span>test)
</span></span><span style="display:flex;"><span>        threads<span style="color:#f92672">.</span>append(t)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> t <span style="color:#f92672">in</span> threads:
</span></span><span style="display:flex;"><span>        t<span style="color:#f92672">.</span>setDaemon(<span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>        t<span style="color:#f92672">.</span>start()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> t <span style="color:#f92672">in</span> threads:
</span></span><span style="display:flex;"><span>        t<span style="color:#f92672">.</span>join()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print <span style="color:#e6db74">&#34;Total use time </span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> int(time() <span style="color:#f92672">-</span> start)
</span></span></code></pre></div><p><img src="/img/post/thread_mutex.png" alt="互斥锁同步"></p>
<ul>
<li>队列(推荐)</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -*- coding: utf-8 -*-</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> re
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> random
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> Queue
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> threading
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> time <span style="color:#f92672">import</span> time,ctime,sleep
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>queue <span style="color:#f92672">=</span> Queue<span style="color:#f92672">.</span>Queue()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> xrange(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">20</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>    queue<span style="color:#f92672">.</span>put(i) <span style="color:#75715e">#put一次队列里的任务数就加1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test</span>(queue):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#f92672">not</span> queue<span style="color:#f92672">.</span>empty():
</span></span><span style="display:flex;"><span>        sleep(random<span style="color:#f92672">.</span>random()) <span style="color:#75715e">#随机生成的一个实数，它在(0,1)范围内</span>
</span></span><span style="display:flex;"><span>        i <span style="color:#f92672">=</span> queue<span style="color:#f92672">.</span>get()
</span></span><span style="display:flex;"><span>        print i
</span></span><span style="display:flex;"><span>        queue<span style="color:#f92672">.</span>task_done()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    start <span style="color:#f92672">=</span> int(time())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    threads <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">20</span>):
</span></span><span style="display:flex;"><span>        t <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Thread(target<span style="color:#f92672">=</span>test, args<span style="color:#f92672">=</span>(queue,))
</span></span><span style="display:flex;"><span>        threads<span style="color:#f92672">.</span>append(t)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> t <span style="color:#f92672">in</span> threads:
</span></span><span style="display:flex;"><span>        t<span style="color:#f92672">.</span>setDaemon(<span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>        t<span style="color:#f92672">.</span>start()
</span></span><span style="display:flex;"><span>    queue<span style="color:#f92672">.</span>join() <span style="color:#75715e">#等待队列里的任务数为0，即队列为空任务完成</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print <span style="color:#e6db74">&#34;Total use time </span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> int(time() <span style="color:#f92672">-</span> start)
</span></span></code></pre></div><p><img src="/img/post/thread_queue.png" alt="队列解决线程竞争问题"></p>
<h3 id="0x03-多线程与类与队列">0x03 多线程与类与队列</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -*- coding: utf-8 -*-</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">使用步骤：
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">1. 继承线程类 threading.Thread
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">2. 重写线程类的__init__方法
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">3. 重写线程类的run方法
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">4. 继承类每实例化一次就创建一个线程
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">__init__方法一般接收外部参数并存放到实例变量
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">实例化对象调用start()方法后运行了run()方法
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> re
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> random
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> Queue
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> threading
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> time <span style="color:#f92672">import</span> time,ctime,sleep
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>hosts <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;http://www.baidu.com&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;http://www.qq.com&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;http://www.github.com&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;http://www.jingyingba.com&#34;</span>
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>queue <span style="color:#f92672">=</span> Queue<span style="color:#f92672">.</span>Queue()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ThreadTest</span>(threading<span style="color:#f92672">.</span>Thread):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;docstring for ThreadTest&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, queue):
</span></span><span style="display:flex;"><span>        threading<span style="color:#f92672">.</span>Thread<span style="color:#f92672">.</span>__init__(self)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>queue <span style="color:#f92672">=</span> queue
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>queue<span style="color:#f92672">.</span>empty():
</span></span><span style="display:flex;"><span>            host <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>queue<span style="color:#f92672">.</span>get()
</span></span><span style="display:flex;"><span>            resp <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(host)
</span></span><span style="display:flex;"><span>            resp<span style="color:#f92672">.</span>encoding <span style="color:#f92672">=</span> resp<span style="color:#f92672">.</span>apparent_encoding
</span></span><span style="display:flex;"><span>            title <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>search(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;&lt;title&gt;(.*?)&lt;/title&gt;&#39;</span>,resp<span style="color:#f92672">.</span>text,re<span style="color:#f92672">.</span>I)<span style="color:#f92672">.</span>group(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>            print <span style="color:#e6db74">&#34;URL:</span><span style="color:#e6db74">%-30s</span><span style="color:#e6db74">Title:</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (host, title)
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>queue<span style="color:#f92672">.</span>task_done()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> host <span style="color:#f92672">in</span> hosts:
</span></span><span style="display:flex;"><span>        queue<span style="color:#f92672">.</span>put(host)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> xrange(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">4</span>):
</span></span><span style="display:flex;"><span>        t <span style="color:#f92672">=</span> ThreadTest(queue)
</span></span><span style="display:flex;"><span>        t<span style="color:#f92672">.</span>setDaemon(<span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>        t<span style="color:#f92672">.</span>start()
</span></span><span style="display:flex;"><span>    queue<span style="color:#f92672">.</span>join()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    start <span style="color:#f92672">=</span> time()
</span></span><span style="display:flex;"><span>    main()
</span></span><span style="display:flex;"><span>    print <span style="color:#e6db74">&#34;Total use time </span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> int(time() <span style="color:#f92672">-</span> start)
</span></span></code></pre></div><p><img src="/img/post/thread_multithreading_queue_class.png" alt="使用多线程和类和队列"></p>
</div>
    </article>
  </main>

    </div>
    <footer>
  <hr />
  
    <p id="social">
      Find me around the web:
      
        
        <a href="https://github.com/reber0?_blank">GitHub</a>
      
         • 
        <a href="https://weibo.com/u/5819760166?_blank">Weibo</a>
      
    </p>
  
  <p class="copyright">
    Copyright © 2015-2024
    <a href="https://wyb0.com/"><strong>Reber</strong></a>.

    Built with
    <a href="http://www.gohugo.io/">Hugo</a>,
    based on the theme
    <a href="https://gitlab.com/ian-s-mcb/smigle-hugo-theme">smigle</a>.
  </p>
</footer>

  </body>
</html>
