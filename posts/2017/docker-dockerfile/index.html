<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Dockerfile 中写的是一条条指令，你可以通过 Dockerfile 更简单的构造自己的环境"/>
  <meta name="author" content="Reber"/>
  
    
      <title>Docker 之 Dockerfile | Reber&#39;s Blog</title>
    
  
  <link rel="stylesheet" href="/css/reset.css"/>
  <link rel="stylesheet" href="/css/font.css"/>
  <link rel="stylesheet" href="/css/smigle.css"/>
  
    <link rel="stylesheet" href="/css/monokai-sublime.min.css"/>
  
    <link rel="stylesheet" href="/css/style.css"/>
  
  
    <script src="/js/jquery-3.6.0.min.js"/></script>
  
    <script src="/js/highlight.min.js"/></script>
  
    <script src="/js/style.js"/></script>
  
  <link rel="icon" type="image/img" sizes="16x16" href="/img/logo.png">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
</head>

  <body>
    <header>
  <div id="brand">
    <a class="icon-link" href="https://wyb0.com/">
      <img
        class="icon"
        src="/img/logo.png"
      />
    </a>
    <div class="text">
      <a href="https://wyb0.com/"><h1>Reber&#39;s Blog</h1></a>
      <h3>只会一点点编程、只会一点点渗透</h3>
    </div>
  </div>
  <nav>
    
      
        
        <a href="/"><b>Home</b></a>
      
         | 
        <a href="/posts/"><b>Posts</b></a>
      
         | 
        <a href="/categories/"><b>Categories</b></a>
      
         | 
        <a href="/tags/"><b>Tags</b></a>
      
         | 
        <a href="/about/"><b>About</b></a>
      
         | 
        <a href="/friends/"><b>Friends</b></a>
      
    
  </nav>
  <hr />
</header>

    <div id="content">
      
  <main>
    <article>
      <h1>Docker 之 Dockerfile</h1>
      <div class="post-meta">
  <strong>
    <span>Posted on</span>
    <time>2017-08-18</time>
    <span>in</span>
    
      <a href="/categories/Linux">Linux</a>
  </strong>
  <span> • 1642 words</span>
  
  
  
    <div>
      <span>Tags:</span>
      
        <a href="/tags/docker">docker</a>
    </div>
  
</div>

      <div>

<p>操作系统：macOS Sierra 10.12.6<br />
Docker版本：Docker version 18.09.0, build 4d60db4</p>

<h3 id="0x00-dockerfile">0x00 Dockerfile</h3>

<pre><code>Dockerfile里面其实是一条条的指令，Docker会把Dockerfile的指令翻译为linux命令，
每一条指令都会创建一个镜像，下一条指令将在这个镜像的基础上进行修改操作后再生成一个镜像。
让你可以对下载好的镜像进行一些操作(比如安装软件、向镜像复制文件等)，从而构造定制化的镜像。
</code></pre>

<h3 id="0x01-dockerfile基本指令">0x01 Dockerfile基本指令</h3>

<pre><code class="language-bash">FROM &lt;image name&gt;：指定新的镜像基于什么创建(可以尝试使用alpine:latest和debian:jessie)
MAINTAINER &lt;author name&gt;：设置该镜像的作者
COPY &lt;source&gt; &lt;dest&gt;：复制文件，dest要以 / 结尾
WORKDIR /path/to/workdir：相当于切换目录，对RUN、CMD、和ENTRYPOINT生效
RUN &lt;command&gt;：在shell执行命令
EXPOSE port1 port2：容器运行时监听的端口
CMD：容器默认的执行命令，Dockerfile只允许使用一次CMD命令(使用数组)
ENTRYPOINT：类似于CMD，Dockerfile只允许使用一次(使用数组)
ENV &lt;key&gt; &lt;value&gt;：设置环境变量
USER &lt;uid&gt;：镜像正在运行时设置一个uid，即设定启动容器的用户，默认为root
VOLUME ['/data']：授权访问从容器内到主机的目录
</code></pre>

<p>CMD与ENTRYPOINT的区别：</p>

<pre><code class="language-bash">#docker run ubuntu:test会执行/bin/echo 'this is test'
CMD ['/bin/echo','this is test']

#docker run ubuntu:test会执行/bin/echo 'entrypoint test'，会输出'entrypoint test'
ENTRYPOINT ['/bin/echo','entrypoint test']

#docker run ubuntu:test init即执行/etc/init.d/mysql init，CMD中的默认参数会被覆盖
ENTRYPOINT ['/etc/init.d/mysql']
CMD [&quot;reinit&quot;]#CMD中的值会作为ENTRYPOINT的默认参数
</code></pre>

<h3 id="0x02-实例">0x02 实例</h3>

<pre><code class="language-bash">reber@wyb:~$ tree range
range
├── Dockerfile
└── src
    ├── init.sh
    ├── privileges.sql
    ├── range.zip
    └── sources.list

1 directory, 5 files
</code></pre>

<ul>
<li>Dockerfile</li>
</ul>

<pre><code class="language-bash">reber@wyb:~/range$ cat Dockerfile
FROM ubuntu:14.04
MAINTAINER reber &lt;1070018473@qq.com&gt;

COPY ./src /data
WORKDIR /data
RUN chmod +x init.sh
RUN cp sources.list /etc/apt/sources.list &amp;&amp; apt-get update &amp;&amp; apt-get upgrade -y
RUN apt-get install -y apache2 mysql-server mysql-client php5
RUN apt-get install -y php5-gd php5-mysql libapache2-mod-php5 libapache2-mod-auth-mysql
RUN apt-get clean

RUN apt-get install -y zip
RUN set -x \
    &amp;&amp; unzip -x /data/range.zip -d /var/www/html \
    &amp;&amp; chmod 777 /var/www/html/range/upload/uploads \
    &amp;&amp; chmod 777 /var/www/html/range/xss_platform/upload

WORKDIR /var/www/html
EXPOSE 80

CMD [&quot;/data/init.sh&quot;]
</code></pre>

<ul>
<li>src/privileges.sql</li>
</ul>

<pre><code class="language-sql">reber@wyb:~/range$ cat src/privileges.sql
use mysql;
UPDATE user SET password=PASSWORD('root') where USER='root';
FLUSH PRIVILEGES;
</code></pre>

<ul>
<li>src/sources.list</li>
</ul>

<pre><code class="language-bash">reber@wyb:~/range$ cat src/sources.list
deb http://debian.ustc.edu.cn/ubuntu/ trusty main restricted universe multiverse
deb http://debian.ustc.edu.cn/ubuntu/ trusty-security main restricted universe multiverse
deb http://debian.ustc.edu.cn/ubuntu/ trusty-updates main restricted universe multiverse
deb http://debian.ustc.edu.cn/ubuntu/ trusty-proposed main restricted universe multiverse
deb http://debian.ustc.edu.cn/ubuntu/ trusty-backports main restricted universe multiverse
deb-src http://debian.ustc.edu.cn/ubuntu/ trusty main restricted universe multiverse
deb-src http://debian.ustc.edu.cn/ubuntu/ trusty-security main restricted universe multiverse
deb-src http://debian.ustc.edu.cn/ubuntu/ trusty-updates main restricted universe multiverse
deb-src http://debian.ustc.edu.cn/ubuntu/ trusty-proposed main restricted universe multiverse
deb-src http://debian.ustc.edu.cn/ubuntu/ trusty-backports main restricted universe multiverse
</code></pre>

<ul>
<li>src/init.sh</li>
</ul>

<pre><code class="language-bash">reber@wyb:~/range$ cat src/init.sh
#!/bin/bash
set -x

echo 'start mysql'
find /var/lib/mysql -type f -exec touch {} \; &amp;&amp; /etc/init.d/mysql start
sleep 3

echo 'import rtest.sql'
mysql &lt; /var/www/html/range/rtest.sql
sleep 3

echo 'set password'
mysql &lt; /data/privileges.sql

find /var/lib/mysql -type f -exec touch {} \; &amp;&amp; /etc/init.d/mysql restart
/etc/init.d/apache2 restart

echo 'set success'

/usr/bin/tail -f /dev/null
</code></pre>

<h3 id="0x03-构建镜像">0x03 构建镜像</h3>

<pre><code class="language-bash">#构建镜像
reber@wyb:~/range$ docker build -t range:v1.0 .

#运行容器，并将容器的80端口转到宿主机的8888端口
reber@wyb:~/range$ docker run -itd --name range_test -p 8888:80 range:v1.0
</code></pre>

<p>运行时mysql没有启动，进容器查看日志如下：</p>

<pre><code class="language-ini">root@d31d5d70fd29:/var/www/html# cat /var/log/mysql/error.log|grep 'ERROR'
ERROR: 1064  You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'ALTER TABLE user ADD column Show_view_priv enum('N','Y') CHARACTER SET utf8 NOT ' at line 1
190110  5:04:54 [ERROR] Aborting
ERROR: 1050  Table 'plugin' already exists
190110  5:04:58 [ERROR] Aborting
190110  5:05:50 [ERROR] Can't open the mysql.plugin table. Please run mysql_upgrade to create it.
190110  5:05:51 [ERROR] Fatal error: Can't open and lock privilege tables: Got error 140 from storage engine
</code></pre>

<p>解决方案：<br />
在启动mysql的语句前执行 <code>&quot;find /var/lib/mysql -type f -exec touch {} \;&quot;</code> (init.sh中已经加了)<br />
参考：<a href="https://github.com/docker/for-linux/issues/72?_blank">https://github.com/docker/for-linux/issues/72</a>和<a href="https://github.com/parsa-epfl/cloudsuite/pull/99?_blank">https://github.com/parsa-epfl/cloudsuite/pull/99</a></p>

<p>重新build容器，查看log，启动成功
<img src="/img/post/20190110-141535.png" alt="" /></p>

<h3 id="0x04-注意事项">0x04 注意事项</h3>

<ul>
<li>使用缓存</li>
</ul>

<p>因为每条指令都会创建一个镜像，若一个镜像已经存在的话则不会重新执行指令创建新镜像，而是直接使用。<br />
为有效的利用已存在的镜像，应保持Dockerfile的一致性，尽量在末尾修改，比如说前几行都如下设置：</p>

<pre><code>FROM ubuntu:14.04

MAINTAINER reber &lt;1070018473@qq.com&gt;

RUN echo &quot;deb http://archive.ubuntu.com/ubuntu precise main universe&quot; &gt; /etc/apt/sourse.list
RUN apt-get update
RUN apt-get upgrade -y #尽量不要upgrade
</code></pre>

<ul>
<li>使用标签</li>
</ul>

<p>始终使用-t参数给镜像打标签：docker build -t ubuntu:range1 .</p>

<ul>
<li>公开端口</li>
</ul>

<p>Docker镜像应该能在任何主机上运行，所以不要通过Dockerfile映射公有端口，只映射私有端口：EXPOSE 80</p>

<ul>
<li>CMD与ENTRYPOINT</li>
</ul>

<p>应该使用数组语法，两者可以结合使用</p>

<pre><code>ENTRYPOINT [&quot;/init.sh&quot;] #docker run的参数将传递给init.sh
CMD [&quot;--help&quot;] #若没有参数传递则显示帮助文档
</code></pre>
</div>
    </article>
  </main>

    </div>
    <footer>
  <hr />
  
    <p id="social">
      Find me around the web:
      <br />
      
        
        <a href="https://github.com/reber0?_blank">GitHub</a>
      
         | 
        <a href="https://weibo.com/u/5819760166?_blank">Weibo</a>
      
    </p>
  
  <p class="copyright">
    Copyright © 2015-2022
    <a href="https://wyb0.com/"><strong>Reber</strong></a>.

    Built with
    <a href="http://www.gohugo.io/">Hugo</a>,
    using the theme
    <a href="https://gitlab.com/ian-s-mcb/smigle-hugo-theme">smigle</a>.
  </p>
</footer>

  </body>
</html>
