

<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ThinkPHP5的where函数 - Reber's Blog</title>
    <meta name="keywords" content="渗透测试,web安全,漏洞,python,php,linux">
    <meta name="description" content="thinkphp的where函数可以接收字符串和数组，接收字符串时就可能存在注入，还是使用数组来传值吧。。。">
    <meta name="author" content="reber">
    <link rel="stylesheet" type="text/css" href="/css/pure-min.css">
    <!--[if lte IE 8]>
    <link rel="stylesheet" type="text/css" href="/css/grids-responsive-old-ie-min.css">
    <![endif]-->
    <!--[if gt IE 8]><!-->
    <link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css">
    <!--<![endif]-->
    <link rel="stylesheet" type="text/css" href="/css/style.css">
    <link rel="stylesheet" type="text/css" href="/css/font-awesome.min.css">
    <link rel="shortcut icon" type="image/x-icon" href="/img/favicon.ico" />
    <link rel="alternate" type="application/rss+xml" title="Reber&#39;s Blog" href="/index.xml" />
    <link rel="stylesheet" href="/css/monokai-sublime.css" type="text/css">
    <script src="/js/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/jquery.min.js"></script>
</head>
<body>



<div class="reber">
    
<div class="head">
    <h1 class="logo" id="logo">
        <a href="/"><img src='/img/logo.png' width='70px'></a>
    </h1>
    <ul class="nav">
        
            
                <li>
                    <a href="/"><i class='fa fa-home fa-fw'></i>Home</a>
            
                </li>
        
            
                <li>
                    <a href="/posts/"><i class='fa fa-list fa-fw'></i>Archive</a>
            
                </li>
        
            
                <li>
                    <a href="/about/"><i class='fa fa-user fa-fw'></i>About</a>
            
                </li>
        
    </ul>
</div>


    <div class="main">
        <div class="left">
            <div>
                <h2>ThinkPHP5的where函数</h2>
                
                <div class="post-meta">
                    <div style="padding:5px 5px 2px 5px;">
                        <i class="fa fa-calendar fa-fw"></i>
                        <time>
                            2018-04-16 19:16
                        </time>
                        &nbsp;&nbsp;&nbsp;&nbsp;
                    

                    

                    
                        
                        
                        
                            <i class="fa fa-folder fa-fw"></i>
                            
                                <a class="post-taxonomy-topic" href="https://wyb0.com/topics/pentest">Pentest</a>&nbsp;&#47;
                            
                                <a class="post-taxonomy-topic" href="https://wyb0.com/topics/php">PHP</a>
                            
                        
                        
                        &nbsp;&nbsp;&nbsp;&nbsp;
                        
                        
                        
                            <i class="fa fa-tags fa-fw"></i>
                            
                                <a class="post-taxonomy-tag" href="https://wyb0.com/tags/injection">injection</a>&nbsp;&#47;
                            
                                <a class="post-taxonomy-tag" href="https://wyb0.com/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1">代码审计</a>
                            
                        
                        
                    </div>
                </div>
                
            </div>
            <div class="content">
                
                

<h3 id="0x00-关于thinkphp5的where函数">0x00 关于thinkphp5的where函数</h3>

<p>年前公司委托别的公司开发一个网站，使用的是ThinkPHP 5.0.13，存在一个注入漏洞，分析后发现是因为tp5中的where函数使用不当，tp5中where这个函数可以接收字符串和数组这两种类型的参数来进行查询，而在用字符串这种传递方式时，如果使用不当的话就可能会出现sql注入。</p>

<h3 id="0x01-示例代码">0x01 示例代码</h3>

<p>tp5/application/home/controller/Index.php</p>

<pre><code>&lt;?php
namespace app\home\controller;

use think\Db;

class Index
{   
    //http://127.0.0.1/Source/tp5/home/index/testdb/id/1
    public function testDb()
    {
        // 调用 tp5/thinkphp/library/think/Db.php 的 connect() 函数 初始化数据库，并取得数据库类实例
        $msg = db('msg');

        $id = input('param.id',1); //不存在id的话默认为1

        //在Db.php中use think\db\Query; $msg-&gt;where()则调用了Query.php中的where函数进入查询流程
        $result = $msg-&gt;where(&quot;id=&quot;.$id)-&gt;select();
        // $result = $msg-&gt;where(['id'=&gt;$id])-&gt;select();

        echo '&lt;br/&gt;&lt;hr/&gt;执行的sql语句：';
        echo $msg-&gt;getLastSql();
        echo '&lt;br/&gt;最终得到的结果：';
        echo var_dump($result);
    }
}
</code></pre>

<p>where函数接收字符串和数组时，访问<code>http://127.0.0.1/Source/tp5/home/index/testdb/id/1</code>执行的SQL语句分别如下：</p>

<pre><code>SELECT * FROM `msg` WHERE ( id=1 )

SELECT * FROM `msg` WHERE `id` = 1
</code></pre>

<p>前者存在注入，当payload为: <f>) and 1=1 and (1)=(1</f>时判断返回如下：
<img src="/img/post/tp5_where_str1.png" alt="80" />
<img src="/img/post/tp5_where_str2.png" alt="45" />
主要调用文件及函数顺序如下：</p>

<pre><code class="language-html">调用 tp5/thinkphp/library/think/Db.php 的 connect() 函数 初始化数据库，并取得数据库类实例

调用 tp5/thinkphp/library/think/db/Query.php 的 __construct() 函数
    ==&gt;调用 tp5/thinkphp/library/think/db/Builder.php 的 __construct() 函数

调用 tp5/thinkphp/library/think/db/Query.php 的 where() 函数
调用 tp5/thinkphp/library/think/db/Query.php 的 select() 函数
    ==&gt;调用 tp5/thinkphp/library/think/db/Query.php 的 parseExpress 函数进行相关解析
    ==&gt;调用 tp5/thinkphp/library/think/db/Builder.php 的 select() 函数得到最终执行的sql语句
    ==&gt;调用 tp5/thinkphp/library/think/db/Query.php 的 query() 函数
</code></pre>

<h3 id="0x02-调用流程中where的处理">0x02 调用流程中where的处理</h3>

<ul>
<li>tp5/thinkphp/library/think/db/Query.php 的 where()</li>
</ul>

<pre><code>//指定AND查询条件
public function where($field, $op = null, $condition = null)
{
    $param = func_get_args(); //array(1) { [0]=&gt; string(24) &quot;id=1) and 1=1 and (1)=(1&quot; } 
    array_shift($param); //array(0) { } 
    $this-&gt;parseWhereExp('AND', $field, $op, $condition, $param);
    return $this;
}

//分析查询表达式
protected function parseWhereExp($logic, $field, $op, $condition, $param = [])
{
    //$logic='AND'
    //$field=&quot;id=1) and 1=1 and (1)=(1&quot;
    $logic = strtoupper($logic);
    if ($field instanceof \Closure) {
        $this-&gt;options['where'][$logic][] = is_string($op) ? [$op, $field] : $field;
        return;
    }

    if (is_string($field) &amp;&amp; !empty($this-&gt;options['via']) &amp;&amp; !strpos($field, '.')) {
        $field = $this-&gt;options['via'] . '.' . $field;
    }

    if (is_string($field) &amp;&amp; preg_match('/[,=\&gt;\&lt;\'\&quot;\(\s]/', $field)) {//进入
        $where[] = ['exp', $field];
        // echo '&lt;pre&gt;';
        // var_dump($where);
        // echo '&lt;pre&gt;';
        if (is_array($op)) {//跳出
            // 参数绑定
            $this-&gt;bind($op);
        }
    } elseif (is_null($op) &amp;&amp; is_null($condition)) {
        if (is_array($field)) {
            // 数组批量查询
            $where = $field;
            foreach ($where as $k =&gt; $val) {
                $this-&gt;options['multi'][$logic][$k][] = $val;
            }
        } elseif ($field &amp;&amp; is_string($field)) {
            // 字符串查询
            $where[$field]                            = ['null', ''];
            $this-&gt;options['multi'][$logic][$field][] = $where[$field];
        }
    } elseif (is_array($op)) {
        $where[$field] = $param;
    } elseif (in_array(strtolower($op), ['null', 'notnull', 'not null'])) {
        // null查询
        $where[$field]                            = [$op, ''];
        $this-&gt;options['multi'][$logic][$field][] = $where[$field];
    } elseif (is_null($condition)) {
        // 字段相等查询
        $where[$field]                            = ['eq', $op];
        $this-&gt;options['multi'][$logic][$field][] = $where[$field];
    } else {
        $where[$field] = [$op, $condition, isset($param[2]) ? $param[2] : null];
        if ('exp' == strtolower($op) &amp;&amp; isset($param[2]) &amp;&amp; is_array($param[2])) {
            // 参数绑定
            $this-&gt;bind($param[2]);
        }
        // 记录一个字段多次查询条件
        $this-&gt;options['multi'][$logic][$field][] = $where[$field];
    }
    if (!empty($where)) {//进入
        if (!isset($this-&gt;options['where'][$logic])) {//进入
            $this-&gt;options['where'][$logic] = [];
        }
        if (is_string($field) &amp;&amp; $this-&gt;checkMultiField($field, $logic)) {
            $where[$field] = $this-&gt;options['multi'][$logic][$field];
        } elseif (is_array($field)) {
            foreach ($field as $key =&gt; $val) {
                if ($this-&gt;checkMultiField($key, $logic)) {
                    $where[$key] = $this-&gt;options['multi'][$logic][$key];
                }
            }
        }
        $this-&gt;options['where'][$logic] = array_merge($this-&gt;options['where'][$logic], $where);
        //array(1) { [0]=&gt; array(2) { [0]=&gt; string(3) &quot;exp&quot; [1]=&gt; string(24) &quot;id=1) and 1=1 and (1)=(1&quot; } } 
    }
}
</code></pre>

<p>Query.php这里面经过where和parseWhereExp的处理后把数组存入了<code>options['where'][$logic]</code>里面</p>

<p>不过这里处理后我们拼接的数据没有变，这样where()就处理好了，接着调用select()</p>

<h3 id="0x03-调用流程中select的处理-这里就query得到结果了">0x03 调用流程中select的处理(这里就query得到结果了)</h3>

<p>流程的话分三步：</p>

<p>1、解析参数：在tp5/thinkphp/library/db/Query.php的select()函数中调用$this-&gt;parseExpress(); 进行表达式的解析</p>

<p>2、生成sql语句：在tp5/thinkphp/library/db/Query.php的select()函数中调用Builder.php里的select()处理上面解析后的参数最终生成sql语句</p>

<p>3、执行sql语句：在tp5/thinkphp/library/db/Query.php的select()函数中调用$this-&gt;query()得到结果</p>

<ul>
<li>解析参数(tp5/thinkphp/library/db/Query.php)</li>
</ul>

<pre><code>//查找记录
public function select($data = null)
{
    if ($data instanceof Query) {
        return $data-&gt;select();
    } elseif ($data instanceof \Closure) {
        call_user_func_array($data, [ &amp; $this]);
        $data = null;
    }
    // 分析查询表达式
    $options = $this-&gt;parseExpress();//分析了表达式，把查的表、查的列、查询条件都存到$options

    if (false === $data) {
        // 用于子查询 不查询只返回SQL
        $options['fetch_sql'] = true;
    } elseif (!is_null($data)) {
        // 主键条件分析
        $this-&gt;parsePkWhere($data, $options);
    }

    $resultSet = false;
    if (empty($options['fetch_sql']) &amp;&amp; !empty($options['cache'])) {
        // 判断查询缓存
        $cache = $options['cache'];
        unset($options['cache']);
        $key       = is_string($cache['key']) ? $cache['key'] : md5(serialize($options) . serialize($this-&gt;bind));
        $resultSet = Cache::get($key);
    }
    if (false === $resultSet) {//进入
        // 生成查询SQL
        //这里调用tp5/thinkphp/library/db/Builder.php里的select()处理，生成sql语句如下：
        //$sql = &quot;SELECT * FROM `msg` WHERE  (  id=1) and 1=1 and (1)=(1)&quot;
        $sql = $this-&gt;builder-&gt;select($options);
        //echo &quot;&lt;br&gt;最终生成的sql语句：&quot;.$sql.&quot;&lt;br&gt;&quot;;

        // 获取参数绑定
        $bind = $this-&gt;getBind();
        if ($options['fetch_sql']) {//跳过
            // 获取实际执行的SQL语句
            return $this-&gt;connection-&gt;getRealSql($sql, $bind);
        }

        $options['data'] = $data;//$data是空的

        if ($resultSet = $this-&gt;trigger('before_select', $options)) {
        } else {//进入，这里就执行了sql查询操作了，造成注入
            // 执行查询操作
            //调用 tp5/thinkphp/library/think/db/Connection.php 的 query() 函数
            $resultSet = $this-&gt;query($sql, $bind, $options['master'], $options['fetch_pdo']);

            if ($resultSet instanceof \PDOStatement) {
                // 返回PDOStatement对象
                return $resultSet;
            }
        }

        if (isset($cache) &amp;&amp; false !== $resultSet) {
            // 缓存数据集
            $this-&gt;cacheData($key, $resultSet, $cache);
        }
    }

    /*
    省略部分代码
    */

    // 返回结果处理
    if (!empty($options['fail']) &amp;&amp; count($resultSet) == 0) {
        $this-&gt;throwNotFound($options);
    }
    // var_dump($resultSet);
    return $resultSet;
}

//分析表达式（可用于查询或者写入操作）
protected function parseExpress()
{
    $options = $this-&gt;options;//将where()处理后的数据给options

    // 获取数据表
    if (empty($options['table'])) {//进入，得到查询的表名
        $options['table'] = $this-&gt;getTable(); //string(3) &quot;msg&quot; 
    }

    if (!isset($options['where'])) {
        $options['where'] = [];
    } elseif (isset($options['view'])) {
        // 视图查询条件处理
        foreach (['AND', 'OR'] as $logic) {
            if (isset($options['where'][$logic])) {
                foreach ($options['where'][$logic] as $key =&gt; $val) {
                    if (array_key_exists($key, $options['map'])) {
                        $options['where'][$logic][$options['map'][$key]] = $val;
                        unset($options['where'][$logic][$key]);
                    }
                }
            }
        }

        if (isset($options['order'])) {
            // 视图查询排序处理
            if (is_string($options['order'])) {
                $options['order'] = explode(',', $options['order']);
            }
            foreach ($options['order'] as $key =&gt; $val) {
                if (is_numeric($key)) {
                    if (strpos($val, ' ')) {
                        list($field, $sort) = explode(' ', $val);
                        if (array_key_exists($field, $options['map'])) {
                            $options['order'][$options['map'][$field]] = $sort;
                            unset($options['order'][$key]);
                        }
                    } elseif (array_key_exists($val, $options['map'])) {
                        $options['order'][$options['map'][$val]] = 'asc';
                        unset($options['order'][$key]);
                    }
                } elseif (array_key_exists($key, $options['map'])) {
                    $options['order'][$options['map'][$key]] = $val;
                    unset($options['order'][$key]);
                }
            }
        }
    }

    if (!isset($options['field'])) {//进入，设置查询的列名为*
        $options['field'] = '*';
    }

    if (!isset($options['data'])) {//进入
        $options['data'] = [];
    }

    if (!isset($options['strict'])) {//进入，bool(true)
        $options['strict'] = $this-&gt;getConfig('fields_strict');
    }

    foreach (['master', 'lock', 'fetch_pdo', 'fetch_sql', 'distinct'] as $name) {
        if (!isset($options[$name])) {//进入，$options[$name]置为false
            $options[$name] = false;
        }
    }

    foreach (['join', 'union', 'group', 'having', 'limit', 'order', 'force', 'comment'] as $name) {
        if (!isset($options[$name])) {//进入，$options[$name]置为''
            $options[$name] = '';
        }
    }

    if (isset($options['page'])) {
        // 根据页数计算limit
        list($page, $listRows) = $options['page'];
        $page                  = $page &gt; 0 ? $page : 1;
        $listRows              = $listRows &gt; 0 ? $listRows : (is_numeric($options['limit']) ? $options['limit'] : 20);
        $offset                = $listRows * ($page - 1);
        $options['limit']      = $offset . ',' . $listRows;
    }

    $this-&gt;options = [];
    // echo '&lt;pre&gt;';
    //     var_dump($options);
    // echo '&lt;pre&gt;';
    return $options;
}
</code></pre>

<ul>
<li>生成SQL语句(tp5/thinkphp/library/db/Builder.php)</li>
</ul>

<pre><code>//生成查询SQL
public function select($options = [])
{
    //这里主要分析一下$this-&gt;parseWhere($options['where'], $options),
    $sql = str_replace(
        ['%TABLE%', '%DISTINCT%', '%FIELD%', '%JOIN%', '%WHERE%', '%GROUP%', '%HAVING%', '%ORDER%', '%LIMIT%', '%UNION%', '%LOCK%', '%COMMENT%', '%FORCE%'],
        [
            $this-&gt;parseTable($options['table'], $options),
            $this-&gt;parseDistinct($options['distinct']),
            $this-&gt;parseField($options['field'], $options),
            $this-&gt;parseJoin($options['join'], $options),
            $this-&gt;parseWhere($options['where'], $options),
            $this-&gt;parseGroup($options['group']),
            $this-&gt;parseHaving($options['having']),
            $this-&gt;parseOrder($options['order'], $options),
            $this-&gt;parseLimit($options['limit']),
            $this-&gt;parseUnion($options['union']),
            $this-&gt;parseLock($options['lock']),
            $this-&gt;parseComment($options['comment']),
            $this-&gt;parseForce($options['force']),
        ], $this-&gt;selectSql);
    return $sql;
}

//where分析
protected function parseWhere($where, $options)
{
    $whereStr = $this-&gt;buildWhere($where, $options);//( id=1) and 1=1 and (1)=(1 )
    if (!empty($options['soft_delete'])) {//跳过
        // 附加软删除条件
        list($field, $condition) = $options['soft_delete'];

        $binds    = $this-&gt;query-&gt;getFieldsBind($options['table']);
        $whereStr = $whereStr ? '( ' . $whereStr . ' ) AND ' : '';
        $whereStr = $whereStr . $this-&gt;parseWhereItem($field, $condition, '', $options, $binds);
    }
    return empty($whereStr) ? '' : ' WHERE ' . $whereStr;
}

//生成查询条件SQL
public function buildWhere($where, $options)
{
    if (empty($where)) {
        $where = [];
    }

    if ($where instanceof Query) {//跳过
        return $this-&gt;buildWhere($where-&gt;getOptions('where'), $options);
    }

    $whereStr = '';
    $binds    = $this-&gt;query-&gt;getFieldsBind($options['table']);
    //$binds 为 array(4) { [&quot;id&quot;]=&gt; int(1) [&quot;name&quot;]=&gt; int(2) [&quot;title&quot;]=&gt; int(2) [&quot;content&quot;]=&gt; int(2) }

    /*
    $where结构如下：
    array(1) {
      [&quot;AND&quot;]=&gt;
      array(1) {
        [0]=&gt;
        array(2) {
          [0]=&gt;
          string(3) &quot;exp&quot;
          [1]=&gt;
          string(24) &quot;id=1) and 1=1 and (1)=(1&quot;
        }
      }
    }
    */
    foreach ($where as $key =&gt; $val) {//$key为AND
        $str = [];
        foreach ($val as $field =&gt; $value) {//$field为0
            if ($value instanceof \Closure) {
                // 使用闭包查询
                $query = new Query($this-&gt;connection);
                call_user_func_array($value, [ &amp; $query]);
                $whereClause = $this-&gt;buildWhere($query-&gt;getOptions('where'), $options);
                if (!empty($whereClause)) {
                    $str[] = ' ' . $key . ' ( ' . $whereClause . ' )';
                }
            } elseif (strpos($field, '|')) {
                // 不同字段使用相同查询条件（OR）
                $array = explode('|', $field);
                $item  = [];
                foreach ($array as $k) {
                    $item[] = $this-&gt;parseWhereItem($k, $value, '', $options, $binds);
                }
                $str[] = ' ' . $key . ' ( ' . implode(' OR ', $item) . ' )';
            } elseif (strpos($field, '&amp;')) {
                // 不同字段使用相同查询条件（AND）
                $array = explode('&amp;', $field);
                $item  = [];
                foreach ($array as $k) {
                    $item[] = $this-&gt;parseWhereItem($k, $value, '', $options, $binds);
                }
                $str[] = ' ' . $key . ' ( ' . implode(' AND ', $item) . ' )';
            } else {//进入
                // 对字段使用表达式查询
                $field = is_string($field) ? $field : '';//$field为''

                /*
                * 传递到parseWhereItem的参数如下：
                * $field为 ''
                * $value为 array(2) { [0]=&gt; string(3) &quot;exp&quot; [1]=&gt; string(24) &quot;id=1) and 1=1 and (1)=(1&quot; }
                *   $key为 AND
                * $binds为 array(4) { [&quot;id&quot;]=&gt; int(1) [&quot;name&quot;]=&gt; int(2) [&quot;title&quot;]=&gt; int(2) [&quot;content&quot;]=&gt; int(2) }
                */
                $str[] = ' ' . $key . ' ' . $this-&gt;parseWhereItem($field, $value, $key, $options, $binds);
                // $str为array(1) { [0]=&gt; string(34) &quot; AND ( id=1) and 1=1 and (1)=(1 )&quot; } 
            }
        }
        
        //substr处理掉多出来的AND
        $whereStr .= empty($whereStr) ? substr(implode(' ', $str), strlen($key) + 1) : implode(' ', $str);
    }

    return $whereStr;//最后输出( id=1) and 1=1 and (1)=(1 )
}

// where子单元分析
protected function parseWhereItem($field, $val, $rule = '', $options = [], $binds = [], $bindName = null)
{
    // 字段分析
    $key = $field ? $this-&gt;parseKey($field, $options) : '';//$key为''

    // 查询规则和条件
    if (!is_array($val)) {
        $val = is_null($val) ? ['null', ''] : ['=', $val];
    }
    list($exp, $value) = $val;//$exp为exp，$value为id=1) and 1=1 and (1)=(1

    // 对一个字段使用多个查询条件
    if (is_array($exp)) {
        $item = array_pop($val);
        // 传入 or 或者 and
        if (is_string($item) &amp;&amp; in_array($item, ['AND', 'and', 'OR', 'or'])) {
            $rule = $item;
        } else {
            array_push($val, $item);
        }
        foreach ($val as $k =&gt; $item) {
            $bindName = 'where_' . str_replace('.', '_', $field) . '_' . $k;
            $str[]    = $this-&gt;parseWhereItem($field, $item, $rule, $options, $binds, $bindName);
        }
        return '( ' . implode(' ' . $rule . ' ', $str) . ' )';
    }

    // 检测操作符
    if (!in_array($exp, $this-&gt;exp)) {//进入，$exp的值从exp变为了EXP
        $exp = strtolower($exp);
        if (isset($this-&gt;exp[$exp])) {
            $exp = $this-&gt;exp[$exp];//$exp为EXP
        } else {
            throw new Exception('where express error:' . $exp);
        }
    }
    $bindName = $bindName ?: 'where_' . str_replace(['.', '-'], '_', $field);
    // $bindName 是 where_
    if (preg_match('/\W/', $bindName)) {
        // 处理带非单词字符的字段名
        $bindName = md5($bindName);
    }

    if (is_object($value) &amp;&amp; method_exists($value, '__toString')) {
        // 对象数据写入
        $value = $value-&gt;__toString();
    }

    $bindType = isset($binds[$field]) ? $binds[$field] : PDO::PARAM_STR;
    //返回PDO::PARAM_STR，即数字2

    if (is_scalar($value) &amp;&amp; array_key_exists($field, $binds) &amp;&amp; !in_array($exp, ['EXP', 'NOT NULL', 'NULL', 'IN', 'NOT IN', 'BETWEEN', 'NOT BETWEEN']) &amp;&amp; strpos($exp, 'TIME') === false) {
        if (strpos($value, ':') !== 0 || !$this-&gt;query-&gt;isBind(substr($value, 1))) {
            if ($this-&gt;query-&gt;isBind($bindName)) {
                $bindName .= '_' . str_replace('.', '_', uniqid('', true));
            }
            $this-&gt;query-&gt;bind($bindName, $value, $bindType);
            $value = ':' . $bindName;
        }
    }

    $whereStr = '';
    if (in_array($exp, ['=', '&lt;&gt;', '&gt;', '&gt;=', '&lt;', '&lt;='])) {
        // 比较运算
        if ($value instanceof \Closure) {
            $whereStr .= $key . ' ' . $exp . ' ' . $this-&gt;parseClosure($value);
        } else {
            $whereStr .= $key . ' ' . $exp . ' ' . $this-&gt;parseValue($value, $field);
        }
    } elseif ('LIKE' == $exp || 'NOT LIKE' == $exp) {
        // 模糊匹配
        if (is_array($value)) {
            foreach ($value as $item) {
                $array[] = $key . ' ' . $exp . ' ' . $this-&gt;parseValue($item, $field);
            }
            $logic = isset($val[2]) ? $val[2] : 'AND';
            $whereStr .= '(' . implode($array, ' ' . strtoupper($logic) . ' ') . ')';
        } else {
            $whereStr .= $key . ' ' . $exp . ' ' . $this-&gt;parseValue($value, $field);
        }
    } elseif ('EXP' == $exp) {//进入
        // 表达式查询
        //$key为''，$value为id=1) and 1=1 and (1)=(1
        //到此结束，$whereStr为(  id=1) and 1=1 and (1)=(1 )
        $whereStr .= '( ' . $key . ' ' . $value . ' )';

    } elseif (in_array($exp, ['NOT NULL', 'NULL'])) {
        // NULL 查询
        $whereStr .= $key . ' IS ' . $exp;
    } elseif (in_array($exp, ['BETWEEN TIME', 'NOT BETWEEN TIME'])) {
        if (is_string($value)) {
            $value = explode(',', $value);
        }

        $whereStr .= $key . ' ' . substr($exp, 0, -4) . $this-&gt;parseDateTime($value[0], $field, $options, $bindName . '_between_1', $bindType) . ' AND ' . $this-&gt;parseDateTime($value[1], $field, $options, $bindName . '_between_2', $bindType);
    }
    // var_dump($whereStr);
    return $whereStr;
}
</code></pre>

<ul>
<li>执行sql语句(tp5/thinkphp/library/db/Query.php)</li>
</ul>

<pre><code>//执行查询 返回数据集
public function query($sql, $bind = [], $master = false, $class = false)
{
    return $this-&gt;connection-&gt;query($sql, $bind, $master, $class);
}
</code></pre>

                
                <div style="padding:10px 1px;">
                    <font color="FF0000">若未作声明则文章版权归本人(<f>@reber</f>)所有，转载请注明原文链接：</font>
                    <script>
                        var link = decodeURI(window.location.href);
                        var url = '<a href="' + link + '">'+link+'</a>';
                        document.write(url);
                    </script>
                </div>

                
<div class="prev-next-post pure-g">
    <div class="pure-u-12-24" style="text-align: left;">
        
        <nav class="prev">
            <a href="https://wyb0.com/posts/2018/cve-2017-10271/">
                <i class="fa fa-chevron-left"></i>&nbsp;&nbsp;&nbsp;WebLogic 反序列化漏洞(CVE-2017-10271)
            </a>
        </nav>
        
    </div>
    <div class="pure-u-12-24" style="text-align: right;">
        
        <nav class="next">
            <a href="https://wyb0.com/posts/2018/injection-tips-of-mysql/">
                SQL注入tips(MySQL)&nbsp;&nbsp;&nbsp;<i class="fa fa-chevron-right"></i>
            </a>
        </nav>
        
    </div>
</div>

            </div>
        </div>
        <div class="right">
            

<div style="padding-bottom:10px;">


    <h2 class="asidetitle">Categorie<a href="/single/index.html" class="single" target="_blank">s</a></h2>
    <ul style="margin-left:10px;margin-bottom:0px;left:10px;">
        
            <li style="list-style-type:none;">
                <i class="fa fa-folder fa-fw"></i>
                <a href="https://wyb0.com/topics/database" title="database">database(10)</a>
            </li>
        
            <li style="list-style-type:none;">
                <i class="fa fa-folder fa-fw"></i>
                <a href="https://wyb0.com/topics/git" title="git">git(4)</a>
            </li>
        
            <li style="list-style-type:none;">
                <i class="fa fa-folder fa-fw"></i>
                <a href="https://wyb0.com/topics/javascript" title="javascript">javascript(4)</a>
            </li>
        
            <li style="list-style-type:none;">
                <i class="fa fa-folder fa-fw"></i>
                <a href="https://wyb0.com/topics/linux" title="linux">linux(25)</a>
            </li>
        
            <li style="list-style-type:none;">
                <i class="fa fa-folder fa-fw"></i>
                <a href="https://wyb0.com/topics/other" title="other">other(13)</a>
            </li>
        
            <li style="list-style-type:none;">
                <i class="fa fa-folder fa-fw"></i>
                <a href="https://wyb0.com/topics/pentest" title="pentest">pentest(82)</a>
            </li>
        
            <li style="list-style-type:none;">
                <i class="fa fa-folder fa-fw"></i>
                <a href="https://wyb0.com/topics/php" title="php">php(12)</a>
            </li>
        
            <li style="list-style-type:none;">
                <i class="fa fa-folder fa-fw"></i>
                <a href="https://wyb0.com/topics/python" title="python">python(24)</a>
            </li>
        
            <li style="list-style-type:none;">
                <i class="fa fa-folder fa-fw"></i>
                <a href="https://wyb0.com/topics/server" title="server">server(10)</a>
            </li>
        
            <li style="list-style-type:none;">
                <i class="fa fa-folder fa-fw"></i>
                <a href="https://wyb0.com/topics/windows" title="windows">windows(2)</a>
            </li>
        
    </ul>


</div>
            

<div style="padding-bottom:10px;">


    <h2 class="asidetitle">Tags</h2>
    <div class="taglist" id="tags">
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/ajax" title="ajax">ajax</a>
                <sup>3</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/backdoor" title="backdoor">backdoor</a>
                <sup>1</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/cgi" title="cgi">cgi</a>
                <sup>1</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/csrf" title="csrf">csrf</a>
                <sup>1</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/c%e8%af%ad%e8%a8%80" title="c语言">c语言</a>
                <sup>1</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/dedecms" title="dedecms">dedecms</a>
                <sup>1</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/des" title="des">des</a>
                <sup>1</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/deserialize" title="deserialize">deserialize</a>
                <sup>4</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/dmz" title="dmz">dmz</a>
                <sup>1</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/docker" title="docker">docker</a>
                <sup>6</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/fileupload" title="fileupload">fileupload</a>
                <sup>3</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/getshell" title="getshell">getshell</a>
                <sup>4</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/git" title="git">git</a>
                <sup>4</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/https" title="https">https</a>
                <sup>1</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/injection" title="injection">injection</a>
                <sup>18</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/intranet" title="intranet">intranet</a>
                <sup>11</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/javascript" title="javascript">javascript</a>
                <sup>2</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/linux" title="linux">linux</a>
                <sup>10</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/mindmap" title="mindmap">mindmap</a>
                <sup>2</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/miscellanea" title="miscellanea">miscellanea</a>
                <sup>3</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/module" title="module">module</a>
                <sup>7</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/mongodb" title="mongodb">mongodb</a>
                <sup>1</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/mysql" title="mysql">mysql</a>
                <sup>4</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/oracle" title="oracle">oracle</a>
                <sup>2</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/pentest" title="pentest">pentest</a>
                <sup>4</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/php" title="php">php</a>
                <sup>11</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/poc" title="poc">poc</a>
                <sup>1</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/postgresql" title="postgresql">postgresql</a>
                <sup>1</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/python" title="python">python</a>
                <sup>22</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/rce" title="rce">rce</a>
                <sup>6</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/redis" title="redis">redis</a>
                <sup>2</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/server" title="server">server</a>
                <sup>11</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/software" title="software">software</a>
                <sup>8</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/sqlserver" title="sqlserver">sqlserver</a>
                <sup>2</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/ssh%e9%9a%a7%e9%81%93" title="ssh隧道">ssh隧道</a>
                <sup>1</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/ssrf" title="ssrf">ssrf</a>
                <sup>2</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/thread" title="thread">thread</a>
                <sup>1</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/tools" title="tools">tools</a>
                <sup>11</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/wireless" title="wireless">wireless</a>
                <sup>2</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/xml" title="xml">xml</a>
                <sup>3</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/xss" title="xss">xss</a>
                <sup>4</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/%e4%bb%a3%e7%a0%81%e5%ae%a1%e8%ae%a1" title="代码审计">代码审计</a>
                <sup>1</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/%e4%bf%a1%e6%81%af%e6%b3%84%e9%9c%b2" title="信息泄露">信息泄露</a>
                <sup>2</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/%e5%8f%8d%e5%bc%b9shell" title="反弹shell">反弹shell</a>
                <sup>1</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/%e6%93%8d%e4%bd%9c%e7%b3%bb%e7%bb%9f" title="操作系统">操作系统</a>
                <sup>1</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/%e6%95%8f%e6%84%9f%e4%bf%a1%e6%81%af%e6%b3%84%e9%9c%b2" title="敏感信息泄露">敏感信息泄露</a>
                <sup>1</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab" title="文件包含">文件包含</a>
                <sup>1</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/%e6%ad%a3%e5%88%99" title="正则">正则</a>
                <sup>1</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/%e7%88%86%e7%a0%b4" title="爆破">爆破</a>
                <sup>3</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/%e7%a4%be%e5%b7%a5" title="社工">社工</a>
                <sup>1</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/%e7%ab%af%e5%8f%a3%e8%bd%ac%e5%8f%91" title="端口转发">端口转发</a>
                <sup>2</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/%e7%bd%91%e7%bb%9c%e8%ae%be%e5%a4%87" title="网络设备">网络设备</a>
                <sup>2</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/%e8%99%9a%e6%8b%9f%e6%9c%ba" title="虚拟机">虚拟机</a>
                <sup>1</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/%e9%80%bb%e8%be%91%e6%bc%8f%e6%b4%9e" title="逻辑漏洞">逻辑漏洞</a>
                <sup>2</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/%e9%87%8d%e5%ae%9a%e5%90%91" title="重定向">重定向</a>
                <sup>1</sup>
            </p>
        
            <p style="display:inline-block;">
                <a href="https://wyb0.com/tags/%e9%92%93%e9%b1%bc" title="钓鱼">钓鱼</a>
                <sup>1</sup>
            </p>
        
    </div>


</div>

            

<div style="padding-bottom:10px;">
    <h2 class="asidetitle">Links</h2>
    <ul style="margin-left:10px;margin-bottom:0px;left:10px;">
        <li style="list-style-type:none;">
            <i class="fa fa-link fa-fw"></i><a href="http://www.test404.com/" target="_blank">Test404's Blog</a>
        </li>
        <li style="list-style-type:none;">
            <i class="fa fa-link fa-fw"></i><a href="http://zksmile.me/" target="_blank">Zksmile's Blog</a>
        </li>
        <li style="list-style-type:none;">
            <i class="fa fa-link fa-fw"></i><a href="https://y-hkl.github.io/" target="_blank">Y-HKL's Blog</a>
        </li>
        <li style="list-style-type:none;">
            <i class="fa fa-link fa-fw"></i><a href="https://www.yl0.org/" target="_blank">sòng•sec</a>
        </li>
    </ul>
</div>

            
<div style="padding-bottom:10px;">
    <h2 class="asidetitle">Social</h2>
    <ul style="margin-left:10px;margin-bottom:0px;left:10px;">
        <li style="list-style-type:none;">
            
                <i class="fa fa-github-square fa-fw"></i><a href="https://github.com/reber0" target="_blank">GitHub</a>
            
        </li>
        <li style="list-style-type:none;">
            
                <i class="fa fa-weibo fa-fw"></i><a href="http://weibo.com/u/5819760166" target="_blank">Weibo</a>
            
        </li>
        <li style="list-style-type:none;">
            <i class="fa fa-rss fa-fw"></i><a href="https://wyb0.com/index.xml" target="_blank">RSS</a>
        </li>
    </ul>
</div>
        </div>
    </div>

    <br>
    
<div class="foot">
    <div class="copyright">
        
        Copyright &copy; 2015-<script>var d=new Date();document.write(d.getFullYear());</script> Reber. All Rights Reserved.

        
        <script type="text/javascript" src="https://js.users.51.la/20938483.js"></script>
    </div>
    <script>$('.copyright img').remove();</script>
</div>
</div>

    
    <div class="goToTop">
      <a href="#top" id="goToTop">
        <img src="https://wyb0.com/img/goto_top.png" alt="可以返回顶部" title="回到顶部"/>
      </a>
    </div>

    <script src="/js/style.js"></script>

    
    

</body>
</html>


